<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Words Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .controls select {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .controls select:hover {
            border-color: #667eea;
        }

        .controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .controls button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .stats-summary {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stats-summary.has-discrepancies {
            background: #fff3cd;
            border-bottom: 2px solid #ffc107;
        }

        .stats-summary.all-good {
            background: #d4edda;
            border-bottom: 2px solid #28a745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .stat-value.success {
            color: #28a745;
        }

        .stat-value.error {
            color: #dc3545;
        }

        .discrepancy-alert {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin-top: 15px;
        }

        .discrepancy-alert h3 {
            color: #dc3545;
            margin-bottom: 5px;
        }

        .success-alert {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
        }

        .success-alert h3 {
            color: #28a745;
            margin-bottom: 5px;
        }

        .chart-container {
            padding: 30px;
            background: white;
            border-bottom: 2px solid #e9ecef;
            display: none;
        }

        .chart-container.visible {
            display: block;
        }

        .chart-wrapper {
            max-width: 100%;
            height: 400px;
            margin: 20px auto;
        }

        .info-bar {
            padding: 15px 30px;
            background: #e7f3ff;
            border-bottom: 1px solid #b3d9ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #004085;
            font-size: 0.95rem;
        }

        .info-item strong {
            font-weight: 600;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .th-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .column-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .column-toggle input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
            line-height: 1.5;
        }

        td.hidden-column {
            display: none;
        }

        td.count-match {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        td.count-mismatch {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:nth-child(even):hover {
            background-color: #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 60px 30px;
            color: #6c757d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 30px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        .error h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls select {
                width: 100%;
            }

            .info-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 0.85rem;
            }

            th,
            td {
                padding: 10px 8px;
            }

            .chart-wrapper {
                height: 300px;
            }
        }

        /* Special styling for overview table */
        .overview-table td:nth-child(3) {
            font-family: monospace;
            font-size: 0.85rem;
            max-width: 600px;
            word-wrap: break-word;
        }

        /* Act color coding */
        .act-1 {
            background-color: #e3f2fd !important;
            /* Light Blue */
            border-left: 4px solid #2196f3 !important;
        }

        .act-2 {
            background-color: #f3e5f5 !important;
            /* Light Purple */
            border-left: 4px solid #9c27b0 !important;
        }

        .act-3 {
            background-color: #e8f5e9 !important;
            /* Light Green */
            border-left: 4px solid #4caf50 !important;
        }

        .act-4 {
            background-color: #fff3e0 !important;
            /* Light Orange */
            border-left: 4px solid #ff9800 !important;
        }

        .act-5 {
            background-color: #fce4ec !important;
            /* Light Pink */
            border-left: 4px solid #e91e63 !important;
        }

        .act-6 {
            background-color: #fff9c4 !important;
            /* Light Yellow */
            border-left: 4px solid #fdd835 !important;
        }

        .act-7 {
            background-color: #ffebee !important;
            /* Light Red */
            border-left: 4px solid #f44336 !important;
        }

        .act-continuity-error {
            background-color: #ffcdd2 !important;
            /* Red warning */
            border: 3px solid #c62828 !important;
            animation: pulse-error 2s infinite;
        }

        @keyframes pulse-error {

            0%,
            100% {
                box-shadow: 0 0 5px #c62828;
            }

            50% {
                box-shadow: 0 0 20px #c62828;
            }
        }

        .act-legend {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .act-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .continuity-alert {
            padding: 15px;
            background: #ffcdd2;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin-top: 15px;
        }

        .continuity-alert h3 {
            color: #c62828;
            margin-bottom: 5px;
        }

        .continuity-alert ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .continuity-alert li {
            color: #b71c1c;
            margin: 5px 0;
        }

        .base-count-cell {
            font-weight: bold;
            color: #4a5568;
        }

        .expected-count-cell {
            color: #718096;
        }

        .error-cell {
            background-color: #fed7d7;
            color: #c53030;
            font-weight: bold;
        }

        .success-cell {
            color: #2f855a;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìö Spanish Words Viewer</h1>
            <p>Browse all 250 Spanish word packs and their translations</p>
        </div>

        <div class="controls">
            <label for="csvSelector">Select Pack:</label>
            <select id="csvSelector">
                <option value="SpanishWordsOverview.csv">Overview (All Packs)</option>
            </select>
            <button id="toggleCharts" onclick="toggleCharts()">Show Charts</button>
        </div>

        <div id="statsContainer"></div>

        <div id="chartContainer" class="chart-container">
            <h2 style="text-align: center; margin-bottom: 20px;">üìä Word Distribution Analysis</h2>
            <div class="chart-wrapper">
                <canvas id="wordChart"></canvas>
            </div>
        </div>

        <div class="info-bar" id="infoBar" style="display: none;">
            <div class="info-item">
                <strong>Pack:</strong>
                <span id="packName">-</span>
            </div>
            <div class="info-item">
                <strong>Words:</strong>
                <span class="badge" id="wordCount">0</span>
            </div>
        </div>

        <div class="table-container" id="tableContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading Spanish words data...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_PATH = './'; // Adjust if needed for GitHub Pages
        const TOTAL_PACKS = 250;
        let currentChart = null;
        let currentData = { headers: [], rows: [], filename: '' };

        // Populate dropdown with all pack options
        function populateDropdown() {
            const selector = document.getElementById('csvSelector');

            for (let i = 1; i <= TOTAL_PACKS; i++) {
                const option = document.createElement('option');
                option.value = `SpanishWords${i}.csv`;
                option.textContent = `Pack ${i}`;
                selector.appendChild(option);
            }
        }

        // Parse CSV data
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return { headers: [], rows: [] };

            const headers = parseCSVLine(lines[0]);
            const rows = lines.slice(1).map(line => parseCSVLine(line));

            return { headers, rows };
        }

        // Parse a single CSV line (handles quoted fields)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // Extract act number from act string (e.g., "Act I: Foundation" -> 1)
        function getActNumber(actString) {
            if (!actString) return 0;
            // Order matters! Longer patterns must come first to avoid partial matches
            const match = actString.match(/Act\s+(VII|VI|IV|III|II|I|V)(?:\s|:)/i);
            if (!match) return 0;

            const romanNumerals = {
                'I': 1, 'II': 2, 'III': 3, 'IV': 4,
                'V': 5, 'VI': 6, 'VII': 7
            };

            return romanNumerals[match[1].toUpperCase()] || 0;
        }

        // Check for continuous act progression
        function checkActContinuity(rows) {
            const continuityErrors = [];
            let currentAct = 0;

            rows.forEach((row, index) => {
                const packNum = row[0];
                const actString = row[2]; // Difficulty_Act column
                const actNum = getActNumber(actString);

                if (actNum === 0) {
                    continuityErrors.push({
                        pack: packNum,
                        issue: `Pack ${packNum}: Invalid or missing act designation "${actString}"`
                    });
                    return;
                }

                // Check if act jumped backward
                if (actNum < currentAct) {
                    continuityErrors.push({
                        pack: packNum,
                        rowIndex: index,
                        issue: `Pack ${packNum}: Act continuity broken! Jumped from Act ${romanize(currentAct)} back to ${actString}`,
                        actNum: actNum,
                        expectedAct: currentAct
                    });
                }

                currentAct = actNum;
            });

            return continuityErrors;
        }

        // Convert number to Roman numeral
        function romanize(num) {
            const lookup = { 7: 'VII', 6: 'VI', 5: 'V', 4: 'IV', 3: 'III', 2: 'II', 1: 'I' };
            return lookup[num] || num.toString();
        }

        // Calculate statistics for overview data
        function calculateOverviewStats(rows) {
            let totalBaseWords = 0;
            let totalWords = 0;
            let discrepancies = [];

            // Check continuity once for all rows
            const continuityErrors = checkActContinuity(rows);

            rows.forEach((row, index) => {
                // Columns: 0:Pack, 1:Title, 2:Act, 3:Words, 4:ManualBase, 5:Expected, 6:Actual
                const manualBase = parseInt(row[4]) || 0;
                const expected = parseInt(row[5]) || 0;
                const actual = parseInt(row[6]) || 0;

                totalBaseWords += manualBase;
                totalWords += actual;

                if (expected !== actual) {
                    discrepancies.push({
                        pack: row[0],
                        expected: expected,
                        actual: actual
                    });
                }
            });

            return {
                totalBaseWords,
                totalWords,
                expectedTotalWords: totalBaseWords * 3,
                discrepancies,
                continuityErrors,
                hasDiscrepancies: discrepancies.length > 0,
                hasContinuityErrors: continuityErrors.length > 0
            };
        }

        // Calculate statistics for individual pack
        function calculatePackStats(rows) {
            const totalWords = rows.length;
            const baseWords = Math.floor(totalWords / 3);
            const expectedWords = baseWords * 3;
            const isValid = totalWords === expectedWords;

            return {
                totalWords,
                baseWords,
                expectedWords,
                isValid,
                hasDiscrepancies: !isValid
            };
        }

        // Render statistics summary
        function renderStatsSummary(stats, isOverview) {
            const container = document.getElementById('statsContainer');

            if (isOverview) {
                const hasAnyIssues = stats.hasDiscrepancies || stats.hasContinuityErrors;
                const statusClass = hasAnyIssues ? 'has-discrepancies' : 'all-good';

                let alertMessage = '';
                if (stats.hasDiscrepancies && stats.hasContinuityErrors) {
                    alertMessage = `Found ${stats.discrepancies.length} word count discrepancy issue(s) and ${stats.continuityErrors.length} act continuity issue(s).`;
                } else if (stats.hasDiscrepancies) {
                    alertMessage = `Found ${stats.discrepancies.length} word count discrepancy issue(s) across packs.`;
                } else if (stats.hasContinuityErrors) {
                    alertMessage = `Found ${stats.continuityErrors.length} act continuity issue(s) across packs.`;
                } else {
                    alertMessage = 'All word counts match expected values (base words √ó 3) and acts progress continuously.';
                }

                let continuityHTML = '';
                if (stats.hasContinuityErrors) {
                    continuityHTML = `
                        <div class="continuity-alert">
                            <h3>üö® Act Continuity Errors Detected</h3>
                            <p>Acts should progress continuously without jumping backward (e.g., Act I ‚Üí Act II ‚Üí Act III, not Act I ‚Üí Act II ‚Üí Act I)</p>
                            <ul>
                                ${stats.continuityErrors.map(err => `<li>${escapeHtml(err.issue)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="stats-summary ${statusClass}">
                        <div class="stat-card">
                            <div class="stat-label">Total Words (Actual)</div>
                            <div class="stat-value">${stats.totalWords.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Expected Total Words (Base √ó 3)</div>
                            <div class="stat-value">${stats.expectedTotalWords.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Act Continuity</div>
                            <div class="stat-value ${stats.hasContinuityErrors ? 'error' : 'success'}">
                                ${stats.hasContinuityErrors ? 'ERRORS FOUND' : 'CONTINUOUS'}
                            </div>
                        </div>
                    </div>
                    ${continuityHTML}
                    <div class="alert ${stats.hasDiscrepancies ? 'alert-danger' : 'alert-success'}" style="margin-top: 20px; padding: 15px; border-radius: 8px; background-color: ${stats.hasDiscrepancies ? '#fed7d7' : '#c6f6d5'}; color: ${stats.hasDiscrepancies ? '#c53030' : '#2f855a'};">
                        <strong>${stats.hasDiscrepancies ? '‚ö†Ô∏è Issues Found:' : '‚úÖ Status:'}</strong> ${alertMessage}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="stats-summary ${stats.hasDiscrepancies ? 'has-discrepancies' : 'all-good'}">
                        <div class="stat-card">
                            <div class="stat-label">Total Words (This Pack)</div>
                            <div class="stat-value ${stats.isValid ? 'success' : 'error'}">
                                ${stats.totalWords}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Expected Words (Base √ó 3)</div>
                            <div class="stat-value">${stats.expectedWords}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Validation Status</div>
                            <div class="stat-value ${stats.isValid ? 'success' : 'error'}">
                                ${stats.isValid ? 'VALID' : 'INVALID'}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Create charts for overview data
        function createOverviewChart(rows) {
            // Find min and max base word counts
            let minBaseWords = Infinity;
            let maxBaseWords = -Infinity;

            rows.forEach(row => {
                const baseWordCount = parseInt(row[4]) || 0; // Manual Base is index 4
                minBaseWords = Math.min(minBaseWords, baseWordCount);
                maxBaseWords = Math.max(maxBaseWords, baseWordCount);
            });

            // Group packs by base word count ranges in increments of 2, starting from min
            const ranges = {};
            const INCREMENT = 2;

            rows.forEach(row => {
                const baseWordCount = parseInt(row[4]) || 0;
                const rangeStart = Math.floor((baseWordCount - minBaseWords) / INCREMENT) * INCREMENT + minBaseWords;
                const rangeEnd = rangeStart + INCREMENT;
                const rangeLabel = `${rangeStart}-${rangeEnd}`;

                if (!ranges[rangeLabel]) {
                    ranges[rangeLabel] = {
                        count: 0,
                        rangeStart: rangeStart,
                        packs: []
                    };
                }
                ranges[rangeLabel].count++;
                ranges[rangeLabel].packs.push(row[0]);
            });

            // Sort ranges by range start value
            const sortedRanges = Object.keys(ranges).sort((a, b) => {
                return ranges[a].rangeStart - ranges[b].rangeStart;
            });

            const labels = sortedRanges;
            const data = sortedRanges.map(range => ranges[range].count);

            const ctx = document.getElementById('wordChart').getContext('2d');

            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => `${label} base words`),
                    datasets: [{
                        label: 'Number of Packs',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Packs by Base Word Count',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.y || 0;
                                    const percentage = ((value / rows.length) * 100).toFixed(1);
                                    return `${value} packs (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Packs',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Base Word Count Range',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // Toggle chart visibility
        function toggleCharts() {
            const chartContainer = document.getElementById('chartContainer');
            const button = document.getElementById('toggleCharts');

            if (chartContainer.classList.contains('visible')) {
                chartContainer.classList.remove('visible');
                button.textContent = 'Show Charts';
            } else {
                chartContainer.classList.add('visible');
                button.textContent = 'Hide Charts';

                // Create chart if viewing overview
                if (currentData.filename === 'SpanishWordsOverview.csv') {
                    createOverviewChart(currentData.rows);
                }
            }
        }

        // Toggle column visibility
        function toggleColumn(columnIndex) {
            const table = document.querySelector('table');
            if (!table) return;

            const cells = table.querySelectorAll(`td:nth-child(${columnIndex + 1}), th:nth-child(${columnIndex + 1})`);
            cells.forEach(cell => {
                if (cell.tagName === 'TH') return; // Don't hide header
                cell.classList.toggle('hidden-column');
            });
        }

        // Helper to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Create HTML table from CSV data
        function createTable(headers, rows, isOverview = false, continuityErrors = []) {
            // Create act legend for overview
            let legendHtml = '';
            if (isOverview) {
                legendHtml = `
                    <div class="act-legend">
                        <strong style="margin-right: 10px;">Act Color Legend:</strong>
                        <div class="act-legend-item act-1">Act I</div>
                        <div class="act-legend-item act-2">Act II</div>
                        <div class="act-legend-item act-3">Act III</div>
                        <div class="act-legend-item act-4">Act IV</div>
                        <div class="act-legend-item act-5">Act V</div>
                        <div class="act-legend-item act-6">Act VI</div>
                        <div class="act-legend-item act-7">Act VII</div>
                        <div class="act-legend-item act-continuity-error" style="animation: none; border: 2px solid #c62828;">Continuity Error</div>
                    </div>
                `;
            }

            // Build error lookup for quick access
            const errorRowIndices = new Set(continuityErrors.map(err => err.rowIndex));

            let html = legendHtml + '<table>';

            // Headers with checkboxes
            html += '<thead><tr>';
            headers.forEach((header, index) => {
                html += `<th>
                    <div class="th-content">
                        <span>${escapeHtml(header)}</span>
                        <label class="column-toggle">
                            <input type="checkbox" checked onchange="toggleColumn(${index})">
                            <span>üëÅ</span>
                        </label>
                    </div>
                </th>`;
            });
            html += '</tr></thead>';

            // Rows
            html += '<tbody>';
            rows.forEach((row, rowIndex) => {
                // Get act number for color coding
                let rowClass = '';
                if (isOverview) {
                    const actString = row[2]; // Difficulty_Act column
                    const actNum = getActNumber(actString);

                    // Check if this row has a continuity error
                    if (errorRowIndices.has(rowIndex)) {
                        rowClass = 'act-continuity-error';
                    } else if (actNum > 0) {
                        rowClass = `act-${actNum}`;
                    }
                }

                html += `<tr class="${rowClass}">`;
                row.forEach((cell, index) => {
                    let classes = '';
                    let displayValue = escapeHtml(cell);

                    // Apply conditional formatting for overview counts
                    // 4: Manual Base, 5: Expected, 6: Actual
                    if (isOverview && (index === 4 || index === 5 || index === 6)) {
                        const manualBase = parseInt(row[4]) || 0;
                        const expected = parseInt(row[5]) || 0;
                        const actual = parseInt(row[6]) || 0;

                        if (index === 4) { // Manual Base
                            classes = 'base-count-cell';
                        } else if (index === 5) { // Expected
                            classes = 'expected-count-cell';
                        } else if (index === 6) { // Actual
                            if (actual !== expected) {
                                classes = 'error-cell';
                                displayValue += ` ‚ö†Ô∏è (Exp: ${expected})`;
                            } else {
                                classes = 'success-cell';
                            }
                        }
                    }

                    html += `<td class="${classes}">${displayValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';

            html += '</table>';
            return html;
        }

        // Update info bar
        function updateInfoBar(packName, wordCount) {
            const infoBar = document.getElementById('infoBar');
            const packNameEl = document.getElementById('packName');
            const wordCountEl = document.getElementById('wordCount');

            if (packName === 'Overview') {
                infoBar.style.display = 'none';
            } else {
                infoBar.style.display = 'flex';
                packNameEl.textContent = packName;
                wordCountEl.textContent = wordCount;
            }
        }

        // Load and display CSV
        async function loadCSV(filename) {
            const container = document.getElementById('tableContainer');
            const isOverview = filename === 'SpanishWordsOverview.csv';

            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading ${filename}...</p>
                </div>
            `;

            try {
                const response = await fetch(BASE_PATH + filename);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}: ${response.statusText}`);
                }

                const text = await response.text();
                const { headers, rows } = parseCSV(text);

                // Store current data
                currentData = { headers, rows, filename };

                // Calculate and render statistics
                let stats;
                if (isOverview) {
                    stats = calculateOverviewStats(rows);
                    renderStatsSummary(stats, true);
                } else {
                    stats = calculatePackStats(rows);
                    renderStatsSummary(stats, false);
                }

                // Create and display table
                const tableClass = isOverview ? 'overview-table' : '';
                const continuityErrors = isOverview ? (stats.continuityErrors || []) : [];
                container.innerHTML = `<div class="${tableClass}">${createTable(headers, rows, isOverview, continuityErrors)}</div>`;

                // Update info bar
                if (isOverview) {
                    updateInfoBar('Overview', rows.length);
                } else {
                    const packNumber = filename.match(/\d+/)[0];
                    updateInfoBar(`Pack ${packNumber}`, rows.length);
                }

                // Update chart if visible
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer.classList.contains('visible') && isOverview) {
                    createOverviewChart(rows);
                }

            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        <h3>Error Loading CSV</h3>
                        <p>${error.message}</p>
                        <p>Make sure the CSV file exists at: <code>${BASE_PATH}${filename}</code></p>
                    </div>
                `;
                updateInfoBar('-', 0);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Populate dropdown
            populateDropdown();

            // Load default (Overview)
            loadCSV('SpanishWordsOverview.csv');

            // Add change event listener
            document.getElementById('csvSelector').addEventListener('change', (e) => {
                loadCSV(e.target.value);
            });
        });
    </script>
</body>

</html>