<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Words Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .controls select {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .controls select:hover {
            border-color: #667eea;
        }

        .controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .controls button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .stats-summary {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stats-summary.has-discrepancies {
            background: #fff3cd;
            border-bottom: 2px solid #ffc107;
        }

        .stats-summary.all-good {
            background: #d4edda;
            border-bottom: 2px solid #28a745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .stat-value.success {
            color: #28a745;
        }

        .stat-value.error {
            color: #dc3545;
        }

        .discrepancy-alert {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin-top: 15px;
        }

        .discrepancy-alert h3 {
            color: #dc3545;
            margin-bottom: 5px;
        }

        .success-alert {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
        }

        .success-alert h3 {
            color: #28a745;
            margin-bottom: 5px;
        }

        .chart-container {
            padding: 30px;
            background: white;
            border-bottom: 2px solid #e9ecef;
            display: none;
        }

        .chart-container.visible {
            display: block;
        }

        .chart-wrapper {
            max-width: 100%;
            height: 400px;
            margin: 20px auto;
        }

        .info-bar {
            padding: 15px 30px;
            background: #e7f3ff;
            border-bottom: 1px solid #b3d9ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #004085;
            font-size: 0.95rem;
        }

        .info-item strong {
            font-weight: 600;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .th-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .column-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .column-toggle input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
            line-height: 1.5;
        }

        td.hidden-column {
            display: none;
        }

        td.count-match {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        td.count-mismatch {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:nth-child(even):hover {
            background-color: #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 60px 30px;
            color: #6c757d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 30px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        .error h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls select {
                width: 100%;
            }

            .info-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px 8px;
            }

            .chart-wrapper {
                height: 300px;
            }
        }

        /* Special styling for overview table */
        .overview-table td:nth-child(3) {
            font-family: monospace;
            font-size: 0.85rem;
            max-width: 600px;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Spanish Words Viewer</h1>
            <p>Browse all 250 Spanish word packs and their translations</p>
        </div>

        <div class="controls">
            <label for="csvSelector">Select Pack:</label>
            <select id="csvSelector">
                <option value="SpanishWordsOverview.csv">Overview (All Packs)</option>
            </select>
            <button id="toggleCharts" onclick="toggleCharts()">Show Charts</button>
        </div>

        <div id="statsContainer"></div>

        <div id="chartContainer" class="chart-container">
            <h2 style="text-align: center; margin-bottom: 20px;">üìä Word Distribution Analysis</h2>
            <div class="chart-wrapper">
                <canvas id="wordChart"></canvas>
            </div>
        </div>

        <div class="info-bar" id="infoBar" style="display: none;">
            <div class="info-item">
                <strong>Pack:</strong>
                <span id="packName">-</span>
            </div>
            <div class="info-item">
                <strong>Words:</strong>
                <span class="badge" id="wordCount">0</span>
            </div>
        </div>

        <div class="table-container" id="tableContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading Spanish words data...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_PATH = './'; // Adjust if needed for GitHub Pages
        const TOTAL_PACKS = 250;
        let currentChart = null;
        let currentData = { headers: [], rows: [], filename: '' };

        // Populate dropdown with all pack options
        function populateDropdown() {
            const selector = document.getElementById('csvSelector');

            for (let i = 1; i <= TOTAL_PACKS; i++) {
                const option = document.createElement('option');
                option.value = `SpanishWords${i}.csv`;
                option.textContent = `Pack ${i}`;
                selector.appendChild(option);
            }
        }

        // Parse CSV data
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return { headers: [], rows: [] };

            const headers = parseCSVLine(lines[0]);
            const rows = lines.slice(1).map(line => parseCSVLine(line));

            return { headers, rows };
        }

        // Parse a single CSV line (handles quoted fields)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // Calculate statistics for overview data
        function calculateOverviewStats(rows) {
            let totalBaseWords = 0;
            let totalWords = 0;
            let discrepancies = [];

            rows.forEach((row, index) => {
                const packNum = row[0];
                const autoWordCount = parseInt(row[4]) || 0;
                const manualBaseCount = parseInt(row[5]) || 0;
                const autoBaseChecker = parseInt(row[6]) || 0;

                totalWords += autoWordCount;
                totalBaseWords += manualBaseCount;

                // Check for discrepancies
                const expectedWords = manualBaseCount * 3;
                if (autoWordCount !== expectedWords) {
                    discrepancies.push({
                        pack: packNum,
                        issue: `Pack ${packNum}: auto_word_count (${autoWordCount}) ‚â† manual_base_word_count √ó 3 (${expectedWords})`
                    });
                }

                if (autoWordCount !== autoBaseChecker) {
                    discrepancies.push({
                        pack: packNum,
                        issue: `Pack ${packNum}: auto_word_count (${autoWordCount}) ‚â† auto_base_word_checker (${autoBaseChecker})`
                    });
                }
            });

            return {
                totalBaseWords,
                totalWords,
                expectedTotalWords: totalBaseWords * 3,
                discrepancies,
                hasDiscrepancies: discrepancies.length > 0
            };
        }

        // Calculate statistics for individual pack
        function calculatePackStats(rows) {
            const totalWords = rows.length;
            const baseWords = Math.floor(totalWords / 3);
            const expectedWords = baseWords * 3;
            const isValid = totalWords === expectedWords;

            return {
                totalWords,
                baseWords,
                expectedWords,
                isValid,
                hasDiscrepancies: !isValid
            };
        }

        // Render statistics summary
        function renderStatsSummary(stats, isOverview) {
            const container = document.getElementById('statsContainer');

            if (isOverview) {
                const statusClass = stats.hasDiscrepancies ? 'has-discrepancies' : 'all-good';
                const alertClass = stats.hasDiscrepancies ? 'discrepancy-alert' : 'success-alert';
                const alertTitle = stats.hasDiscrepancies ? '‚ö†Ô∏è Discrepancies Found' : '‚úÖ All Packs Valid';
                const alertMessage = stats.hasDiscrepancies
                    ? `Found ${stats.discrepancies.length} discrepancy issue(s) across packs.`
                    : 'All word counts match expected values (base words √ó 3).';

                container.innerHTML = `
                    <div class="stats-summary ${statusClass}">
                        <div class="${alertClass}">
                            <h3>${alertTitle}</h3>
                            <p>${alertMessage}</p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Base Words (All Packs)</div>
                                <div class="stat-value">${stats.totalBaseWords.toLocaleString()}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Words (All Packs)</div>
                                <div class="stat-value ${stats.totalWords === stats.expectedTotalWords ? 'success' : 'error'}">
                                    ${stats.totalWords.toLocaleString()}
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Expected Total Words (Base √ó 3)</div>
                                <div class="stat-value">${stats.expectedTotalWords.toLocaleString()}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Validation Status</div>
                                <div class="stat-value ${stats.hasDiscrepancies ? 'error' : 'success'}">
                                    ${stats.hasDiscrepancies ? 'ISSUES FOUND' : 'ALL VALID'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const statusClass = stats.hasDiscrepancies ? 'has-discrepancies' : 'all-good';
                const alertClass = stats.hasDiscrepancies ? 'discrepancy-alert' : 'success-alert';
                const alertTitle = stats.hasDiscrepancies ? '‚ö†Ô∏è Pack Has Issues' : '‚úÖ Pack Valid';
                const alertMessage = stats.hasDiscrepancies
                    ? `Word count (${stats.totalWords}) does not equal base words √ó 3 (${stats.expectedWords}).`
                    : `Word count matches expected value (${stats.baseWords} base words √ó 3).`;

                container.innerHTML = `
                    <div class="stats-summary ${statusClass}">
                        <div class="${alertClass}">
                            <h3>${alertTitle}</h3>
                            <p>${alertMessage}</p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Base Words (This Pack)</div>
                                <div class="stat-value">${stats.baseWords}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Words (This Pack)</div>
                                <div class="stat-value ${stats.isValid ? 'success' : 'error'}">
                                    ${stats.totalWords}
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Expected Words (Base √ó 3)</div>
                                <div class="stat-value">${stats.expectedWords}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Validation Status</div>
                                <div class="stat-value ${stats.isValid ? 'success' : 'error'}">
                                    ${stats.isValid ? 'VALID' : 'INVALID'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Create charts for overview data
        function createOverviewChart(rows) {
            // Find min and max base word counts
            let minBaseWords = Infinity;
            let maxBaseWords = -Infinity;

            rows.forEach(row => {
                const baseWordCount = parseInt(row[5]) || 0;
                minBaseWords = Math.min(minBaseWords, baseWordCount);
                maxBaseWords = Math.max(maxBaseWords, baseWordCount);
            });

            // Group packs by base word count ranges in increments of 2, starting from min
            const ranges = {};
            const INCREMENT = 2;

            rows.forEach(row => {
                const baseWordCount = parseInt(row[5]) || 0;
                const rangeStart = Math.floor((baseWordCount - minBaseWords) / INCREMENT) * INCREMENT + minBaseWords;
                const rangeEnd = rangeStart + INCREMENT;
                const rangeLabel = `${rangeStart}-${rangeEnd}`;

                if (!ranges[rangeLabel]) {
                    ranges[rangeLabel] = {
                        count: 0,
                        rangeStart: rangeStart,
                        packs: []
                    };
                }
                ranges[rangeLabel].count++;
                ranges[rangeLabel].packs.push(row[0]);
            });

            // Sort ranges by range start value
            const sortedRanges = Object.keys(ranges).sort((a, b) => {
                return ranges[a].rangeStart - ranges[b].rangeStart;
            });

            const labels = sortedRanges;
            const data = sortedRanges.map(range => ranges[range].count);

            const ctx = document.getElementById('wordChart').getContext('2d');

            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => `${label} base words`),
                    datasets: [{
                        label: 'Number of Packs',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Packs by Base Word Count',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y || 0;
                                    const percentage = ((value / rows.length) * 100).toFixed(1);
                                    return `${value} packs (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Packs',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Base Word Count Range',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // Toggle chart visibility
        function toggleCharts() {
            const chartContainer = document.getElementById('chartContainer');
            const button = document.getElementById('toggleCharts');

            if (chartContainer.classList.contains('visible')) {
                chartContainer.classList.remove('visible');
                button.textContent = 'Show Charts';
            } else {
                chartContainer.classList.add('visible');
                button.textContent = 'Hide Charts';

                // Create chart if viewing overview
                if (currentData.filename === 'SpanishWordsOverview.csv') {
                    createOverviewChart(currentData.rows);
                }
            }
        }

        // Toggle column visibility
        function toggleColumn(columnIndex) {
            const table = document.querySelector('table');
            if (!table) return;

            const cells = table.querySelectorAll(`td:nth-child(${columnIndex + 1}), th:nth-child(${columnIndex + 1})`);
            cells.forEach(cell => {
                if (cell.tagName === 'TH') return; // Don't hide header
                cell.classList.toggle('hidden-column');
            });
        }

        // Create HTML table from CSV data
        function createTable(headers, rows, isOverview = false) {
            let html = '<table>';

            // Headers with checkboxes
            html += '<thead><tr>';
            headers.forEach((header, index) => {
                html += `<th>
                    <div class="th-content">
                        <span>${escapeHtml(header)}</span>
                        <label class="column-toggle">
                            <input type="checkbox" checked onchange="toggleColumn(${index})">
                            <span>üëÅ</span>
                        </label>
                    </div>
                </th>`;
            });
            html += '</tr></thead>';

            // Rows
            html += '<tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, index) => {
                    let classes = '';
                    let displayValue = escapeHtml(cell);

                    // Apply conditional formatting for overview counts
                    if (isOverview && (index === 4 || index === 5 || index === 6)) {
                        const autoWordCount = parseInt(row[4]) || 0;
                        const manualBaseCount = parseInt(row[5]) || 0;
                        const autoBaseChecker = parseInt(row[6]) || 0;
                        const expectedWords = manualBaseCount * 3;

                        if (index === 4) { // auto_word_count
                            if (autoWordCount === expectedWords && autoWordCount === autoBaseChecker) {
                                classes = 'count-match';
                            } else {
                                classes = 'count-mismatch';
                            }
                        } else if (index === 5) { // manual_base_word_count
                            if (expectedWords === autoWordCount) {
                                classes = 'count-match';
                            } else {
                                classes = 'count-mismatch';
                            }
                        } else if (index === 6) { // auto_base_word_checker
                            if (autoBaseChecker === autoWordCount) {
                                classes = 'count-match';
                            } else {
                                classes = 'count-mismatch';
                            }
                        }
                    }

                    html += `<td class="${classes}">${displayValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';

            html += '</table>';
            return html;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update info bar
        function updateInfoBar(packName, wordCount) {
            const infoBar = document.getElementById('infoBar');
            const packNameEl = document.getElementById('packName');
            const wordCountEl = document.getElementById('wordCount');

            if (packName === 'Overview') {
                infoBar.style.display = 'none';
            } else {
                infoBar.style.display = 'flex';
                packNameEl.textContent = packName;
                wordCountEl.textContent = wordCount;
            }
        }

        // Load and display CSV
        async function loadCSV(filename) {
            const container = document.getElementById('tableContainer');
            const isOverview = filename === 'SpanishWordsOverview.csv';

            // Show loading
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading ${filename}...</p>
                </div>
            `;

            try {
                const response = await fetch(BASE_PATH + filename);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}: ${response.statusText}`);
                }

                const text = await response.text();
                const { headers, rows } = parseCSV(text);

                // Store current data
                currentData = { headers, rows, filename };

                // Calculate and render statistics
                if (isOverview) {
                    const stats = calculateOverviewStats(rows);
                    renderStatsSummary(stats, true);
                } else {
                    const stats = calculatePackStats(rows);
                    renderStatsSummary(stats, false);
                }

                // Create and display table
                const tableClass = isOverview ? 'overview-table' : '';
                container.innerHTML = `<div class="${tableClass}">${createTable(headers, rows, isOverview)}</div>`;

                // Update info bar
                if (isOverview) {
                    updateInfoBar('Overview', rows.length);
                } else {
                    const packNumber = filename.match(/\d+/)[0];
                    updateInfoBar(`Pack ${packNumber}`, rows.length);
                }

                // Update chart if visible
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer.classList.contains('visible') && isOverview) {
                    createOverviewChart(rows);
                }

            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        <h3>Error Loading CSV</h3>
                        <p>${error.message}</p>
                        <p>Make sure the CSV file exists at: <code>${BASE_PATH}${filename}</code></p>
                    </div>
                `;
                updateInfoBar('-', 0);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Populate dropdown
            populateDropdown();

            // Load default (Overview)
            loadCSV('SpanishWordsOverview.csv');

            // Add change event listener
            document.getElementById('csvSelector').addEventListener('change', (e) => {
                loadCSV(e.target.value);
            });
        });
    </script>
</body>
</html>
