<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spanish Reading Flashcards</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
  <style>
    /* =================================================================
       TEXTURE DEFINITIONS - Single source of truth for all textures
       Fixed grain size that doesn't change with zoom
       ================================================================= */
    :root {
      /* Paper texture (for cards) - 200x200 viewBox */
      --paper-texture: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23noise)'/%3E%3C/svg%3E");
      --paper-texture-size: 200px 200px;

      /* Cardboard texture (for buttons) - Same 200x200 viewBox, 2x larger grain */
      --cardboard-texture: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23noise)'/%3E%3C/svg%3E");
      --cardboard-texture-size: 400px 400px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: 
        radial-gradient(ellipse at center, #8B7355 0%, #5D4E37 50%, #3D2E1F 100%);
      font-family: 'IM Fell English', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #2C1810;
    }

    /* Remove focus outline from all interactive elements */
    button:focus,
    button:active,
    select:focus,
    input:focus,
    .mode-btn:focus,
    .mode-btn:active,
    .action-btn:focus,
    .action-btn:active,
    .nav-btn:focus,
    .nav-btn:active {
      outline: none !important;
    }

    /* Wordpack Selector */
    .selector-container {
      background: rgba(60, 46, 31, 0.6);
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border: 1px solid rgba(139, 115, 85, 0.3);
    }

    .selector-container label {
      font-size: 1rem;
      margin-right: 10px;
      color: #A89888;
    }

    #wordpack-select {
      font-family: 'IM Fell English', serif;
      font-size: 1rem;
      padding: 8px 15px;
      border: 1px solid rgba(139, 115, 85, 0.4);
      border-radius: 5px;
      background: rgba(45, 35, 25, 0.8);
      color: #D4C4A8;
      cursor: pointer;
      min-width: 200px;
    }

    #wordpack-select:focus {
      outline: none;
      border-color: #8B7355;
      box-shadow: 0 0 5px rgba(139, 115, 85, 0.3);
    }

    #wordpack-select option {
      background: #3D2E1F;
      color: #D4C4A8;
    }

    /* Wordpack Title - Realistic dark gold with noise texture */
    .wordpack-title {
      /* Dark gold to dark brown gradient - realistic gold appearance */
      background-image:
        var(--cardboard-texture),
        linear-gradient(180deg,
          #B8860B 0%,      /* Dark goldenrod */
          #A67C38 20%,     /* Bronzed gold */
          #8B6914 40%,     /* Dark gold */
          #7A5C1A 60%,     /* Deep brown-gold */
          #5D4E37 80%,     /* Dark brown */
          #4A3728 100%     /* Very dark brown */
        );
      background-blend-mode: overlay;
      background-size: var(--cardboard-texture-size), 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
      /* Realistic shadows for metallic depth */
      text-shadow:
        0 2px 4px rgba(0, 0, 0, 0.4),
        0 1px 1px rgba(139, 105, 20, 0.3),
        0 -1px 0 rgba(184, 134, 11, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease;
      letter-spacing: 2px;
      /* Drop shadow for depth */
      filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
    }

    body.game-started .wordpack-title {
      opacity: 1;
    }

    /* Card Counter Wrapper - fixed height prevents layout shift when stamp appears */
    .card-counter-wrapper {
      min-height: 2.5rem; /* Accommodate counter + stamp indicator */
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }

    /* Card Counter */
    .card-counter {
      color: #F5E6D3;
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    body.game-started .card-counter {
      opacity: 1;
    }

    /* Flashcard Container */
    .flashcard-container {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    /* Navigation Arrows - Flat Cardboard Style */
    .nav-btn {
      background-color: #8B7355;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #A08567 0%, #8B7355 30%, #7A6347 60%, #6B5540 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border: 3px solid rgba(74, 56, 40, 0.6);
      color: #2C1810;
      font-size: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      text-align: center;
      opacity: 0;
      pointer-events: none;
    }

    body.game-started .nav-btn {
      opacity: 1;
      pointer-events: auto;
    }

    .nav-btn:hover {
      background-color: #9B8365;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #B09577 0%, #9B8365 30%, #8A7357 60%, #7B6550 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
    }

    .nav-btn:active {
      background-color: #7A6347;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #8B7355 0%, #7A6347 30%, #6B5540 60%, #5D4E37 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
    }

    /* Flashcard */
    .flashcard {
      width: 650px;
      height: 420px;
      position: relative;
      cursor: pointer;
      user-select: none;
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      overflow: hidden; /* Clip content to border-radius */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;

      /* Old paper texture - using CSS variable for consistency */
      background:
        var(--paper-texture),
        linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 30%, #DCC9A3 60%, #D4C4A8 100%);
      background-blend-mode: soft-light;
      background-size: var(--paper-texture-size), 100%;

      /* Use box-shadow for border to avoid corner radius gaps */
      box-shadow:
        0 10px 30px rgba(0,0,0,0.4),
        0 0 0 3px #A08567,
        0 0 0 1px rgba(139, 115, 85, 0.3),
        inset 0 0 50px rgba(139, 115, 85, 0.1);
    }

    .card-face::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(101, 67, 33, 0.1) 0%, transparent 50%);
      border-radius: 12px;
      pointer-events: none;
    }

    /* Torn edge effect - front card only */
    .card-front::after {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border: 1px dashed rgba(139, 115, 85, 0.3);
      border-radius: 4px;
      pointer-events: none;
    }

    /* Subtle grid pattern - back card only */
    .card-back::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(139, 115, 85, 0.08) 19px, rgba(139, 115, 85, 0.08) 20px),
        repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(139, 115, 85, 0.08) 19px, rgba(139, 115, 85, 0.08) 20px);
      border-radius: 12px;
      pointer-events: none;
      opacity: 0.7;
    }

    /* Random weathering overlay */
    .card-weathering {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 12px;
      pointer-events: none;
      z-index: 4;
      opacity: 0.6;
    }

    .card-front {
      z-index: 2;
    }

    .card-back {
      z-index: 1;
      background:
        var(--paper-texture),
        /* Lighter, whiter back card for distinction */
        radial-gradient(ellipse 70% 60% at 30% 35%, rgba(255, 250, 245, 0.3) 0%, transparent 70%),
        radial-gradient(ellipse 60% 55% at 70% 65%, rgba(250, 245, 240, 0.2) 0%, transparent 65%),
        linear-gradient(135deg, #FFFEF9 0%, #F8F5F0 30%, #F0EDE8 60%, #EAE7E2 100%);
      background-blend-mode: soft-light;
      background-size: var(--paper-texture-size), 100%, 100%, 100%;
    }

    /* Reduce edge weathering on back card for distinction */
    .card-back::before {
      opacity: 0.3;
    }

    .flashcard.flipped .card-front {
      z-index: 1;
      opacity: 0;
    }

    .flashcard.flipped .card-back {
      z-index: 2;
      opacity: 1;
    }

    .card-back {
      opacity: 0;
    }

    .card-label {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      color: #8B7355;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      white-space: nowrap;
    }

    .card-word {
      font-size: 4rem;
      color: #2C1810;
      line-height: 1.2;
      font-style: italic;
      position: relative;
      z-index: 5;
      text-align: center;
      max-width: 90%;
      word-break: normal;
      overflow-wrap: break-word;
      hyphens: none;
    }

    /* Sound Button (pronounce - bottom right) */
    .sound-btn {
      position: absolute;
      bottom: 25px;
      right: 25px;
      background: rgba(139, 115, 85, 0.2);
      border: 3px solid rgba(160, 133, 103, 0.5);
      color: #5D4E37;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      line-height: 1;
      text-align: center;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
    }

    .flashcard.game-started .sound-btn {
      opacity: 1;
      pointer-events: auto;
    }

    .sound-btn:hover {
      background: rgba(139, 115, 85, 0.4);
      transform: scale(1.1);
    }

    /* Peek Button (flip/peek at back - top right) */
    .peek-btn {
      position: absolute;
      top: 25px;
      right: 25px;
      background: rgba(139, 115, 85, 0.2);
      border: 3px solid rgba(160, 133, 103, 0.5);
      color: #5D4E37;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      line-height: 1;
      text-align: center;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      user-select: none;
    }

    .flashcard.game-started .peek-btn {
      opacity: 1;
      pointer-events: auto;
    }

    .peek-btn:hover {
      background: rgba(139, 115, 85, 0.4);
      transform: scale(1.1);
    }

    .peek-btn:active {
      background: rgba(139, 115, 85, 0.6);
      transform: scale(1.05);
    }

    /* Mic Button */
    .mic-btn {
      position: absolute;
      bottom: 25px;
      left: 25px;
      background: rgba(139, 115, 85, 0.2);
      border: 3px solid rgba(160, 133, 103, 0.5);
      color: #5D4E37;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      line-height: 1;
      text-align: center;
      z-index: 10;
      display: none; /* Hidden by default, shown only in speaking mode */
    }

    .flashcard.game-started .mic-btn {
      /* Mic button visibility controlled by JavaScript based on mode */
    }

    .mic-btn:hover {
      background: rgba(139, 115, 85, 0.4);
      transform: scale(1.1);
    }

    .mic-btn.listening {
      background: rgba(180, 60, 60, 0.4);
      border-color: #B43C3C;
      animation: pulse-mic 1s infinite;
    }

    @keyframes pulse-mic {
      0%, 100% { box-shadow: 0 0 0 0 rgba(180, 60, 60, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(180, 60, 60, 0); }
    }

    /* Pronunciation Feedback Overlay */
    .pronunciation-feedback {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .pronunciation-feedback.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .feedback-score {
      font-family: 'Cinzel', serif;
      font-size: 3.5rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .feedback-score.excellent {
      color: #4ADE80;
    }

    .feedback-score.good {
      color: #A3E635;
    }

    .feedback-score.okay {
      color: #FACC15;
    }

    .feedback-score.poor {
      color: #F87171;
    }

    .feedback-message {
      font-size: 1.3rem;
      color: #F5E6D3;
      margin-bottom: 8px;
    }

    .feedback-heard {
      font-size: 0.95rem;
      color: #A89888;
      font-style: italic;
      margin-bottom: 15px;
    }

    .feedback-close {
      background: rgba(139, 115, 85, 0.4);
      border: 1px solid #8B7355;
      color: #D4C4A8;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'IM Fell English', serif;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .feedback-close:hover {
      background: rgba(139, 115, 85, 0.6);
    }

    /* Unsupported browser message */
    .mic-unsupported {
      display: none;
    }

    /* Setup Card - Front (Settings) */
    .setup-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        var(--paper-texture),
        linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 30%, #DCC9A3 60%, #D4C4A8 100%);
      background-blend-mode: soft-light;
      background-size: var(--paper-texture-size), 100%;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      z-index: 30;
      transition: opacity 0.4s ease;

      /* Match card styling */
      box-shadow:
        0 10px 30px rgba(0,0,0,0.4),
        0 0 0 1px rgba(139, 115, 85, 0.3),
        inset 0 0 50px rgba(139, 115, 85, 0.1);
      border: 3px solid #A08567;
    }

    .setup-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(101, 67, 33, 0.1) 0%, transparent 50%);
      border-radius: 10px;
      pointer-events: none;
    }

    .setup-overlay::after {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border: 1px dashed rgba(139, 115, 85, 0.3);
      border-radius: 4px;
      pointer-events: none;
    }

    .setup-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Setup Card - Back (How To) - Matches card-back styling */
    .setup-help {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        var(--paper-texture),
        /* Lighter, whiter back card for distinction - matches card-back */
        radial-gradient(ellipse 70% 60% at 30% 35%, rgba(255, 250, 245, 0.3) 0%, transparent 70%),
        radial-gradient(ellipse 60% 55% at 70% 65%, rgba(250, 245, 240, 0.2) 0%, transparent 65%),
        linear-gradient(135deg, #FFFEF9 0%, #F8F5F0 30%, #F0EDE8 60%, #EAE7E2 100%);
      background-blend-mode: soft-light;
      background-size: var(--paper-texture-size), 100%, 100%, 100%;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      padding: 30px;
      z-index: 29;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      overflow-y: auto;

      /* Match card styling */
      box-shadow:
        0 10px 30px rgba(0,0,0,0.4),
        0 0 0 3px #A08567,
        0 0 0 1px rgba(139, 115, 85, 0.3),
        inset 0 0 50px rgba(139, 115, 85, 0.1);
    }

    /* Edge weathering - reduced opacity like card-back */
    .setup-help::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(101, 67, 33, 0.1) 0%, transparent 50%);
      border-radius: 12px;
      pointer-events: none;
      opacity: 0.3;
    }

    /* Subtle grid pattern - matches card-back */
    .setup-help::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(139, 115, 85, 0.08) 19px, rgba(139, 115, 85, 0.08) 20px),
        repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(139, 115, 85, 0.08) 19px, rgba(139, 115, 85, 0.08) 20px);
      border-radius: 12px;
      pointer-events: none;
      opacity: 0.7;
    }

    .flashcard.setup-flipped .setup-overlay {
      opacity: 0;
      pointer-events: none;
      z-index: 29;
    }

    .flashcard.setup-flipped .setup-help {
      opacity: 1;
      pointer-events: auto;
      z-index: 30;
    }

    .flashcard.game-started .setup-overlay,
    .flashcard.game-started .setup-help {
      opacity: 0;
      pointer-events: none;
      z-index: -1;
    }

    .setup-title {
      font-family: 'Courier New', monospace;
      font-size: 1.5rem;
      color: #2C1810;
      margin-bottom: 25px;
      letter-spacing: 2px;
      position: relative;
      z-index: 5;
      font-weight: bold;
    }

    .setup-field {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 15px;
      width: 100%;
      max-width: 280px;
      position: relative;
      z-index: 5;
    }

    .setup-field label {
      font-size: 0.85rem;
      color: #6B5B4B;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .setup-field select {
      font-family: 'IM Fell English', serif;
      font-size: 1rem;
      padding: 10px 15px;
      border: 2px solid #8B7355;
      border-radius: 6px;
      background: rgba(60, 46, 31, 0.85);
      color: #D4C4A8;
      cursor: pointer;
      width: 100%;
      text-align: left;
      text-align-last: left;
    }

    .setup-field select:focus {
      outline: none;
      border-color: #A08567;
      box-shadow: 0 0 8px rgba(139, 115, 85, 0.4);
    }

    .setup-field select option {
      background: #3D2E1F;
      color: #D4C4A8;
      text-align: left;
    }

    /* Setup flip button */
    .setup-flip-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: 2px solid rgba(139, 115, 85, 0.5);
      background: rgba(60, 46, 31, 0.6);
      color: #D4C4A8;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 10;
    }

    .setup-flip-btn:hover {
      background: rgba(139, 115, 85, 0.8);
      transform: scale(1.1);
    }

    /* Help content styling - matches card-back with Courier font */
    .help-content {
      color: #2C1810;
      line-height: 1.7;
      position: relative;
      z-index: 5;
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
    }

    .help-content h3 {
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      color: #2C1810;
      margin: 12px 0 6px;
      font-weight: bold;
    }

    .help-content p {
      margin-bottom: 8px;
    }

    .help-content ul {
      margin-left: 18px;
      margin-bottom: 12px;
    }

    .help-content li {
      margin-bottom: 4px;
    }

    .setup-start-btn {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      padding: 12px 30px;
      margin-top: 15px;
      background-color: #7A6347;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #8B7355 0%, #7A6347 30%, #6B5540 60%, #5D4E37 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border: 3px solid rgba(74, 56, 40, 0.6);
      border-radius: 8px;
      color: #F5E6D3;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      position: relative;
      z-index: 5;
    }

    .setup-start-btn:hover:not(:disabled) {
      background-color: #8A7357;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #9B8365 0%, #8A7357 30%, #7B6550 60%, #6D5E47 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
    }

    .setup-start-btn:disabled {
      background-color: #5A5A4A;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #7A7A6A 0%, #6A6A5A 30%, #5A5A4A 60%, #4A4A3A 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border-color: #3A3A2A;
      color: #9A9A8A;
      cursor: not-allowed;
      text-shadow: none;
    }

    /* Hide card buttons when setup is visible - handled by opacity rules above */

    /* Hide card content when setup is visible */
    .flashcard:not(.game-started) .card-word {
      opacity: 0;
    }

    .flashcard:not(.game-started) .card-label {
      opacity: 0;
    }

    /* Speed Controls in Menu */
    .speed-controls-menu {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .speed-btn {
      flex: 1;
      padding: 10px 8px;
      border-radius: 6px;
      border: 2px solid rgba(139, 115, 85, 0.4);
      background-color: rgba(60, 46, 31, 0.3);
      color: #8A7A6A;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'IM Fell English', serif;
      font-size: 0.9rem;
      text-align: center;
    }

    .speed-btn:hover {
      background-color: rgba(139, 115, 85, 0.3);
      border-color: rgba(139, 115, 85, 0.6);
      color: #9A8A7A;
    }

    .speed-btn.active {
      background-color: rgba(139, 115, 85, 0.6);
      border-color: #8B7355;
      color: #F5E6D3;
    }

    /* Speed buttons on starting card */
    .speed-btn-start {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      border: 2px solid #8B7355;
      background-color: rgba(139, 115, 85, 0.2);
      color: #2C1810;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1.5rem;
      text-align: center;
    }

    .speed-btn-start:hover {
      background-color: rgba(139, 115, 85, 0.3);
      border-color: #7A6347;
    }

    .speed-btn-start.active {
      background-color: #8B7355;
      border-color: #7A6347;
      color: #F5E6D3;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Action Buttons - Styled exactly like mic button */
    .action-btn {
      position: absolute;
      bottom: 25px;
      background: rgba(139, 115, 85, 0.2);
      border: 3px solid rgba(160, 133, 103, 0.5);
      color: #5D4E37;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      line-height: 1;
      text-align: center;
      z-index: 50; /* Higher z-index to appear above card faces (mic is 10, stamps are 100) */
      display: none; /* Hidden by default, shown when game started */
    }

    body.game-started .action-btn {
      display: flex;
    }

    /* Position the four buttons - two on left, two on right */
    /* Bottom Left Corner */
    .got-it-btn {
      left: 25px;
    }

    .confused-btn-left {
      left: 95px; /* 25px + 55px width + 15px gap */
    }

    /* Bottom Right Corner */
    .pronounce-btn {
      right: 25px;
    }

    .confused-btn-right {
      right: 95px; /* 25px + 55px width + 15px gap */
    }

    .action-btn:hover {
      background: rgba(139, 115, 85, 0.4);
      transform: scale(1.1);
    }

    /* Tooltip - styled like card-back with edge burn */
    .action-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      /* EXACT card-back background with edge burn weathering */
      background:
        /* Edge burn weathering */
        radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(101, 67, 33, 0.03) 0%, transparent 50%),
        /* Paper texture and base colors */
        var(--paper-texture),
        radial-gradient(ellipse 70% 60% at 30% 35%, rgba(255, 250, 245, 0.3) 0%, transparent 70%),
        radial-gradient(ellipse 60% 55% at 70% 65%, rgba(250, 245, 240, 0.2) 0%, transparent 65%),
        linear-gradient(135deg, #FFFEF9 0%, #F8F5F0 30%, #F0EDE8 60%, #EAE7E2 100%);
      background-blend-mode: soft-light;
      background-size: 100%, 100%, var(--paper-texture-size), 100%, 100%, 100%;
      color: #2C1810;
      padding: 8px 12px;
      border-radius: 12px;
      /* EXACT box-shadow as card-face */
      box-shadow:
        0 10px 30px rgba(0,0,0,0.4),
        0 0 0 3px #A08567,
        0 0 0 1px rgba(139, 115, 85, 0.3),
        inset 0 0 50px rgba(139, 115, 85, 0.1);
      font-size: 0.85rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      z-index: 100;
    }

    .action-btn:hover::after {
      opacity: 1;
    }

    /* Top Corner Buttons - Flat Cardboard Style */
    .top-btn {
      position: fixed;
      top: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid rgba(74, 56, 40, 0.6);
      background-color: #8B7355;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #A08567 0%, #8B7355 30%, #7A6347 60%, #6B5540 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      color: #2C1810;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      line-height: 1;
      text-align: center;
      z-index: 100;
      font-family: 'Cinzel', serif;
      font-weight: 600;
    }

    .top-btn:hover {
      background-color: #9B8365;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #B09577 0%, #9B8365 30%, #8A7357 60%, #7B6550 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
    }

    .top-btn:active {
      background-color: #7A6347;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #8B7355 0%, #7A6347 30%, #6B5540 60%, #5D4E37 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
    }

    .menu-btn {
      right: 20px;
    }

    .reset-top-btn {
      right: 80px;
      opacity: 0;
      pointer-events: none;
    }

    body.game-started .reset-top-btn {
      opacity: 1;
      pointer-events: auto;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* Modal Card */
    .modal-card {
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 12px;
      padding: 30px;
      position: relative;
      background: 
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"),
        linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 30%, #DCC9A3 60%, #D4C4A8 100%);
      background-blend-mode: soft-light;
      box-shadow: 
        0 10px 30px rgba(0,0,0,0.5),
        0 0 0 1px rgba(139, 115, 85, 0.3),
        inset 0 0 50px rgba(139, 115, 85, 0.1);
      border: 3px solid #A08567;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.2) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(101, 67, 33, 0.1) 0%, transparent 50%);
      border-radius: 10px;
      pointer-events: none;
    }

    .modal-card::after {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border: 1px dashed rgba(139, 115, 85, 0.3);
      border-radius: 4px;
      pointer-events: none;
    }

    .modal-overlay.visible .modal-card {
      transform: scale(1);
    }

    .modal-title {
      font-family: 'Cinzel', serif;
      font-size: 1.5rem;
      color: #4A3728;
      margin-bottom: 20px;
      text-align: center;
      letter-spacing: 2px;
      position: relative;
      z-index: 5;
    }

    .modal-content {
      color: #4A3728;
      line-height: 1.7;
      position: relative;
      z-index: 5;
    }

    .modal-content h3 {
      font-family: 'Cinzel', serif;
      font-size: 1.1rem;
      color: #6B5344;
      margin: 15px 0 8px;
    }

    .modal-content p {
      margin-bottom: 10px;
    }

    .modal-content ul {
      margin-left: 20px;
      margin-bottom: 15px;
    }

    .modal-content li {
      margin-bottom: 5px;
    }

    .modal-close-btn {
      display: block;
      margin: 20px auto 0;
      padding: 10px 25px;
      font-family: 'Cinzel', serif;
      font-size: 1rem;
      background-color: #7A6347;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #8B7355 0%, #7A6347 30%, #6B5540 60%, #5D4E37 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border: 3px solid rgba(74, 56, 40, 0.6);
      border-radius: 6px;
      color: #F5E6D3;
      cursor: pointer;
      transition: all 0.2s ease;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      position: relative;
      z-index: 5;
    }

    .modal-close-btn:hover {
      background-color: #8A7357;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #9B8365 0%, #8A7357 30%, #7B6550 60%, #6D5E47 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
    }

    /* Menu Modal Specific */
    .menu-field {
      margin-bottom: 18px;
    }

    .menu-field label {
      display: block;
      font-size: 0.85rem;
      color: #6B5B4B;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .menu-field select {
      font-family: 'IM Fell English', serif;
      font-size: 1rem;
      padding: 10px 15px;
      border: 2px solid #8B7355;
      border-radius: 6px;
      background: rgba(60, 46, 31, 0.85);
      color: #D4C4A8;
      cursor: pointer;
      width: 100%;
    }

    .menu-field select:focus {
      outline: none;
      border-color: #A08567;
      box-shadow: 0 0 8px rgba(139, 115, 85, 0.4);
    }

    .menu-field select option {
      background: #3D2E1F;
      color: #D4C4A8;
    }

    /* Empty State */
    .empty-state {
      color: #F5E6D3;
      font-size: 1.3rem;
      text-align: center;
      padding: 50px;
    }

    /* Loading State */
    .loading {
      color: #F5E6D3;
      font-size: 1.2rem;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .flashcard {
        width: 340px;
        height: 260px;
      }

      .card-word {
        font-size: 1.5rem;
      }

      .nav-btn {
        width: 45px;
        height: 45px;
        font-size: 1.5rem;
      }

      .action-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }
    }

    /* Shared stamp styling - used by card stamps and deck change indicator */
    .stamp-base {
      font-family: Georgia, serif;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 4px;
      border: 4px solid;
      border-radius: 8px;
      background: transparent;
      mix-blend-mode: multiply;
      text-align: center;
    }

    /* Simple stamp overlays */
    .card-stamp {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 2.5rem;
      padding: 15px 30px;
      opacity: 0;
      pointer-events: none;
      z-index: 100;
      transition: opacity 0.2s ease;
    }

    .removed-stamp {
      color: transparent;
      border-color: rgba(56, 142, 60, 0.7);
      -webkit-text-stroke: 3px rgba(56, 142, 60, 0.7);
      text-stroke: 3px rgba(56, 142, 60, 0.7);
    }

    .added-stamp {
      color: transparent;
      border-color: rgba(211, 47, 47, 0.7);
      -webkit-text-stroke: 3px rgba(211, 47, 47, 0.7);
      text-stroke: 3px rgba(211, 47, 47, 0.7);
    }

    .card-stamp.visible {
      opacity: 1;
    }

    /* Mode Selector - HIDDEN (single-mode game) */
    .mode-selector {
      display: none !important;
    }

    body.game-started .mode-selector {
      opacity: 1;
      pointer-events: auto;
    }

    .mode-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid rgba(74, 56, 40, 0.6);
      /* Inactive: darker, more recessed (old active style) */
      background-color: #7A6347;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #8B7355 0%, #7A6347 30%, #6B5540 60%, #5D4E37 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border-color: #4A3828;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
      color: #2C1810;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      line-height: 1;
      opacity: 0.45; /* Very low opacity for inactive to blend into background */
    }

    .mode-btn:hover {
      background-color: #9B8365;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #B09577 0%, #9B8365 30%, #8A7357 60%, #7B6550 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      transform: scale(1.05);
      opacity: 0.7; /* Medium opacity on hover */
    }

    .mode-btn.active {
      /* Active: lighter, more prominent (old default style) */
      background-color: #8B7355;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #A08567 0%, #8B7355 30%, #7A6347 60%, #6B5540 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border: 3px solid rgba(74, 56, 40, 0.6);
      box-shadow: none; /* No inset shadow - more prominent */
      opacity: 1; /* Full opacity for active */
    }

    /* Typing mode display (listening and writing) */
    .typing-display {
      font-size: 4rem;
      color: #2C1810;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      letter-spacing: 4px;
      position: relative;
      z-index: 5;
      text-align: center;
      word-spacing: 20px;
      word-break: keep-all;
      white-space: normal;
      overflow-wrap: break-word;
    }

    .typing-char {
      display: inline-block;
      min-width: 0.6em;
      text-align: center;
      transition: color 0.2s ease;
    }

    .typing-char.wrong {
      color: #D32F2F;
    }

    .typing-space {
      display: inline-block;
      width: 0.8em;
    }

    /* Translation text (native language) */
    .translation-text {
      font-size: 3rem;
      color: #2C1810;
      font-family: 'Courier New', monospace;
      font-style: normal;
    }

    /* =============================================== */
    /* CUSTOM TOOLTIPS - Hover Explanations */
    /* =============================================== */

    .tooltip-container {
      position: relative;
      display: inline-block;
    }

    .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 300;
      /* EXACT card-back background with edge burn weathering */
      background:
        /* Edge burn weathering (reduced opacity like card-back) */
        radial-gradient(ellipse at 20% 20%, rgba(255,255,255,0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(101, 67, 33, 0.03) 0%, transparent 50%),
        /* Paper texture and base colors */
        var(--paper-texture),
        radial-gradient(ellipse 70% 60% at 30% 35%, rgba(255, 250, 245, 0.3) 0%, transparent 70%),
        radial-gradient(ellipse 60% 55% at 70% 65%, rgba(250, 245, 240, 0.2) 0%, transparent 65%),
        linear-gradient(135deg, #FFFEF9 0%, #F8F5F0 30%, #F0EDE8 60%, #EAE7E2 100%);
      background-blend-mode: soft-light;
      background-size: 100%, 100%, var(--paper-texture-size), 100%, 100%, 100%;
      color: #2C1810;
      padding: 16px 20px;
      border-radius: 12px;
      overflow: hidden;
      /* EXACT box-shadow as card-face */
      box-shadow:
        0 10px 30px rgba(0,0,0,0.4),
        0 0 0 3px #A08567,
        0 0 0 1px rgba(139, 115, 85, 0.3),
        inset 0 0 50px rgba(139, 115, 85, 0.1);
      font-size: 1rem;
      line-height: 1.6;
      white-space: nowrap;
      pointer-events: none;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      font-family: 'Courier New', monospace;
    }

    /* Grid pattern - same as card-back::after */
    .tooltip::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(139, 115, 85, 0.08) 19px, rgba(139, 115, 85, 0.08) 20px),
        repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(139, 115, 85, 0.08) 19px, rgba(139, 115, 85, 0.08) 20px);
      border-radius: 12px;
      pointer-events: none;
      opacity: 0.7;
      z-index: 1;
    }

    /* Position tooltip below mode buttons */
    .mode-btn .tooltip {
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
    }

    /* Position tooltip above flashcard */
    .flashcard .tooltip {
      bottom: calc(100% + 15px);
      left: 50%;
      transform: translateX(-50%);
      max-width: 400px;
      white-space: normal;
      text-align: center;
    }

    /* Show tooltip on hover */
    .tooltip-container:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }

    /* Small arrow pointing to element */
    .tooltip::after {
      content: '';
      position: absolute;
      border: 6px solid transparent;
    }

    /* Arrow pointing up (for tooltips below element) */
    .mode-btn .tooltip::after {
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-bottom-color: #EAE7E2;
    }

    /* Arrow pointing down (for tooltips above element) */
    .flashcard .tooltip::after {
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-top-color: #EAE7E2;
    }

    .tooltip strong {
      /* Mode title - centered, LARGER, bold */
      display: block;
      text-align: center;
      color: #2C1810;
      font-weight: bold;
      font-size: 1.4rem;
      margin-bottom: 4px;
      position: relative;
      z-index: 2;
      font-family: 'Courier New', monospace;
    }

    /* Bold steps - numbered list in tooltips */
    .tooltip b {
      color: #2C1810;
      font-weight: bold;
      position: relative;
      z-index: 2;
      display: inline;
      font-size: 1rem;
      line-height: 1.8;
      font-family: 'Courier New', monospace;
    }

    .tooltip em {
      /* Instructions text - SAME COLOR as everything else */
      color: #2C1810;
      font-style: normal;
      position: relative;
      z-index: 2;
      display: block;
      margin-top: 6px;
      font-size: 0.9rem;
      line-height: 1.8;
      font-family: 'Courier New', monospace;
    }

    /* Bold action words within em (CLICK, PRESS, HOLD, TYPE) */
    .tooltip em b {
      color: #2C1810;
      font-weight: bold;
      text-transform: uppercase;
      font-family: 'Courier New', monospace;
    }

    /* Make all tooltip content appear above grid */
    .tooltip > * {
      position: relative;
      z-index: 2;
    }

    /* Visual button representations in tooltips */
    .tooltip-btn {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #8B7355;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #A08567 0%, #8B7355 30%, #7A6347 60%, #6B5540 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border: 2px solid rgba(74, 56, 40, 0.6);
      color: #2C1810;
      font-size: 0.75rem;
      line-height: 20px;
      text-align: center;
      vertical-align: middle;
      margin: 0 2px;
    }

    .tooltip-key {
      display: inline-block;
      min-width: 28px;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: #8B7355;
      background-image:
        var(--cardboard-texture),
        linear-gradient(135deg, #A08567 0%, #8B7355 30%, #7A6347 60%, #6B5540 100%);
      background-blend-mode: soft-light;
      background-size: var(--cardboard-texture-size), 100%;
      border: 2px solid rgba(74, 56, 40, 0.6);
      color: #2C1810;
      font-size: 0.7rem;
      font-weight: bold;
      line-height: 1.2;
      text-align: center;
      vertical-align: middle;
      margin: 0 2px;
      font-family: 'IM Fell English', serif;
    }
  </style>
</head>
<body>
  <!-- Top Corner Buttons (all on right side) -->
  <button class="top-btn reset-top-btn" id="reset-btn" aria-label="Reset deck">â†º</button>
  <button class="top-btn menu-btn" id="menu-btn" aria-label="Menu">â˜°</button>

  <!-- Menu Modal -->
  <div class="modal-overlay" id="menu-modal">
    <div class="modal-card">
      <div class="modal-title">Settings</div>
      <div class="modal-content">
        <div class="menu-field">
          <label for="menu-wordpack">Wordpack</label>
          <select id="menu-wordpack">
            <option value="">-- Loading... --</option>
          </select>
        </div>
        
        <div class="menu-field">
          <label for="menu-language">I speak</label>
          <select id="menu-language">
            <option value="english">English</option>
            <option value="chinese">ä¸­æ–‡</option>
            <option value="portuguese">PortuguÃªs</option>
          </select>
        </div>
        
        <div class="menu-field">
          <label for="menu-voice">Spanish Voice</label>
          <select id="menu-voice">
            <option value="">Default</option>
          </select>
        </div>

        <div class="menu-field">
          <label for="menu-speed">Speech Speed</label>
          <div class="speed-controls-menu">
            <button class="speed-btn" id="speed-slow" data-speed="0.2" title="Slow">ğŸ¢ Slow</button>
            <button class="speed-btn active" id="speed-normal" data-speed="0.6" title="Normal">ğŸš¶ Normal</button>
            <button class="speed-btn" id="speed-fast" data-speed="1.0" title="Fast">ğŸ‡ Fast</button>
          </div>
        </div>
      </div>
      <button class="modal-close-btn" id="menu-close">Done</button>
    </div>
  </div>

  <div class="wordpack-title" id="wordpack-title"></div>

  <!-- Fixed-height wrapper prevents card from shifting when stamp indicator appears -->
  <div class="card-counter-wrapper">
    <div class="card-counter" id="card-counter">Card 0 of 0</div>
  </div>

  <!-- Mode Selector -->
  <div class="mode-selector">
    <span class="tooltip-container">
      <button class="mode-btn active" id="mode-reading" data-mode="reading">ğŸ“–</button>
      <span class="tooltip"><strong>ğŸ“– Reading Mode</strong><br><b>1. Read Spanish Word<br>2. Flip to See English<br>3. Mark If You Got It Right or Wrong!</b><br><em><b>CLICK</b> <span class="tooltip-btn">ğŸ—£ï¸</span> or <b>PRESS</b> <span class="tooltip-key">â†‘</span> Key to Pronounce<br><b>HOLD</b> <span class="tooltip-btn">ğŸ¤”</span> or <b>HOLD</b> <span class="tooltip-key">â†“</span> Key to Peek at Back<br><b>CLICK</b> <span class="tooltip-btn">â€¹</span> or <b>PRESS</b> <span class="tooltip-key">â†</span> Key to Previous Card<br><b>CLICK</b> <span class="tooltip-btn">â€º</span> or <b>PRESS</b> <span class="tooltip-key">â†’</span> Key to Next Card<br><b>CLICK</b> <span class="tooltip-btn">ğŸ‘Œ</span> or <b>PRESS</b> <span class="tooltip-key">1</span> Key to I Got It Right! (Remove Card)<br><b>CLICK</b> <span class="tooltip-btn">ğŸ˜•</span> or <b>PRESS</b> <span class="tooltip-key">2</span> Key to I Got It Wrong (Need Extra Practice)</em></span>
    </span>
    <span class="tooltip-container">
      <button class="mode-btn" id="mode-listening" data-mode="listening">ğŸ‘‚</button>
      <span class="tooltip"><strong>ğŸ‘‚ Listening Mode</strong><br><b>1. Hear Spanish Word<br>2. Type What You Hear<br>3. Flip to Check Answer</b><br><em><b>CLICK</b> <span class="tooltip-btn">ğŸ—£ï¸</span> or <b>PRESS</b> <span class="tooltip-key">â†‘</span> Key to Pronounce<br><b>TYPE</b> Letters to Spell Word<br><b>HOLD</b> <span class="tooltip-btn">ğŸ¤”</span> or <b>HOLD</b> <span class="tooltip-key">â†“</span> Key to Peek at Back<br><b>PRESS</b> <span class="tooltip-key">Enter</span> Key to Next Card</em></span>
    </span>
    <span class="tooltip-container">
      <button class="mode-btn" id="mode-speaking" data-mode="speaking">ğŸ’¬</button>
      <span class="tooltip"><strong>ğŸ’¬ Speaking Mode</strong><br><b>1. See Spanish Word<br>2. Say It Aloud<br>3. Get Pronunciation Score</b><br><em><b>CLICK</b> <span class="tooltip-btn">ğŸ¤</span> or <b>PRESS</b> <span class="tooltip-key">Space</span> Key to Record<br><b>CLICK</b> <span class="tooltip-btn">ğŸ—£ï¸</span> or <b>PRESS</b> <span class="tooltip-key">â†‘</span> Key to Pronounce<br><b>HOLD</b> <span class="tooltip-btn">ğŸ¤”</span> or <b>HOLD</b> <span class="tooltip-key">â†“</span> Key to Peek at Back</em></span>
    </span>
    <span class="tooltip-container">
      <button class="mode-btn" id="mode-writing" data-mode="writing">âœï¸</button>
      <span class="tooltip"><strong>âœï¸ Writing Mode</strong><br><b>1. See English Translation<br>2. Type Spanish Word<br>3. Flip to Check Answer</b><br><em><b>CLICK</b> <span class="tooltip-btn">ğŸ—£ï¸</span> or <b>PRESS</b> <span class="tooltip-key">â†‘</span> Key to Pronounce<br><b>TYPE</b> Letters to Spell Word<br><b>HOLD</b> <span class="tooltip-btn">ğŸ¤”</span> or <b>HOLD</b> <span class="tooltip-key">â†“</span> Key to Peek at Back<br><b>PRESS</b> <span class="tooltip-key">Enter</span> Key to Next Card</em></span>
    </span>
  </div>

  <div class="flashcard-container">
    <button class="nav-btn" id="prev-btn" aria-label="Previous card">â€¹</button>

    <div class="flashcard" id="flashcard">
      <!-- Setup Overlay (Front - Settings) -->
      <div class="setup-overlay" id="setup-overlay">
        <div class="setup-title">Settings</div>

        <div class="setup-field">
          <label for="wordpack-select">Wordpack</label>
          <select id="wordpack-select">
            <option value="">-- Loading... --</option>
          </select>
        </div>

        <div class="setup-field">
          <label for="language-select">I speak</label>
          <select id="language-select">
            <option value="">-- Select --</option>
            <option value="english">English</option>
            <option value="chinese">ä¸­æ–‡</option>
            <option value="portuguese">PortuguÃªs</option>
          </select>
        </div>

        <div class="setup-field">
          <label for="setup-voice">Spanish Voice</label>
          <select id="setup-voice">
            <option value="">Default</option>
          </select>
        </div>

        <div class="setup-field">
          <label>Speech Speed</label>
          <div class="speed-controls-menu">
            <button class="speed-btn setup-speed-btn" data-speed="0.2">ğŸ¢ Slow</button>
            <button class="speed-btn setup-speed-btn active" data-speed="0.6">ğŸš¶ Normal</button>
            <button class="speed-btn setup-speed-btn" data-speed="1.0">ğŸ‡ Fast</button>
          </div>
        </div>

        <button class="setup-start-btn" id="start-btn" disabled>Start Practice</button>
      </div>

      <!-- Setup Help (Back - How To) -->
      <div class="setup-help" id="setup-help">
        <div class="setup-title">How to Use</div>
        <div class="help-content">
          <h3>ğŸ“š Getting Started</h3>
          <p>Select a wordpack and language, then click Start!</p>

          <h3>ğŸ´ Navigation</h3>
          <ul>
            <li><strong>â€¹ Button</strong> or <strong>â† Key</strong> â€” Previous card</li>
            <li><strong>â€º Button</strong> or <strong>â†’ Key</strong> â€” Next card</li>
          </ul>

          <h3>ğŸ‘ï¸ Viewing</h3>
          <ul>
            <li><strong>Hold ğŸ¤” Button</strong> or <strong>Hold â†“ Key</strong> â€” Peek at back</li>
            <li><strong>Click card</strong> â€” Flip to see other side</li>
          </ul>

          <h3>ğŸ”Š Audio</h3>
          <ul>
            <li><strong>ğŸ—£ï¸ Button</strong> or <strong>â†‘ Key</strong> â€” Hear pronunciation</li>
            <li><strong>ğŸ¤ Button</strong> or <strong>Space Key</strong> â€” Record & score (speaking mode)</li>
          </ul>

          <h3>âœ… Learning Progress</h3>
          <ul>
            <li><strong>ğŸ‘Œ Button</strong> or <strong>1 Key</strong> â€” I got it right! (remove card)</li>
            <li><strong>ğŸ˜• Button</strong> or <strong>2 Key</strong> â€” I got it wrong (add practice)</li>
          </ul>

          <h3>âš™ï¸ Settings</h3>
          <ul>
            <li><strong>â†º Button</strong> â€” Reset deck</li>
            <li><strong>â˜° Button</strong> â€” Open menu</li>
          </ul>
        </div>
      </div>

      <div class="card-face card-front">
        <div class="card-weathering" id="weathering-front"></div>
        <!-- Wrong answer indicators (positioned at card corners) -->
        <div id="wrong-letters-front" style="position: absolute; top: 12px; left: 12px; font-size: 2em; font-family: 'IM Fell English', serif; font-style: italic; font-weight: bold; color: #D32F2F; z-index: 20; max-width: 550px; line-height: 0.9; text-align: left;"></div>
        <div id="wrong-count-front" style="position: absolute; top: 12px; right: 12px; font-size: 2em; font-family: 'IM Fell English', serif; font-style: italic; font-weight: bold; color: #D32F2F; z-index: 20;"></div>
        <span class="card-word" id="spanish-word"></span>
        <button class="mic-btn" id="mic-btn-front" aria-label="Practice pronunciation">ğŸ¤</button>
        <button class="peek-btn" id="peek-btn-front" aria-label="Peek at back">ğŸ¤”</button>
        <div class="pronunciation-feedback" id="feedback-front">
          <div class="feedback-score" id="score-front">0%</div>
          <div class="feedback-message" id="message-front">Try again!</div>
          <div class="feedback-heard" id="heard-front">Heard: ""</div>
          <button class="feedback-close" id="close-front">Got it</button>
        </div>
      </div>
      <div class="card-face card-back">
        <div class="card-weathering" id="weathering-back"></div>
        <span class="card-word" id="english-word"></span>
        <button class="mic-btn" id="mic-btn-back" aria-label="Practice pronunciation">ğŸ¤</button>
        <div class="pronunciation-feedback" id="feedback-back">
          <div class="feedback-score" id="score-back">0%</div>
          <div class="feedback-message" id="message-back">Try again!</div>
          <div class="feedback-heard" id="heard-back">Heard: ""</div>
          <button class="feedback-close" id="close-back">Got it</button>
        </div>
      </div>

      <!-- Stamp overlays for visual feedback -->
      <div class="stamp-base card-stamp removed-stamp" id="removed-stamp">Card Removed</div>
      <div class="stamp-base card-stamp added-stamp" id="added-stamp">Extra Practice</div>

      <!-- Action buttons (positioned above card faces like stamps, visible on both sides) -->
      <!-- Bottom Left: Got It + Confused -->
      <button class="action-btn got-it-btn" id="got-it-btn" data-tooltip="I Got It Right! (Remove Card)">ğŸ‘Œ</button>
      <button class="action-btn confused-btn-left" id="confused-btn-left" data-tooltip="I Got It Wrong (Need Extra Practice)">ğŸ˜•</button>

      <!-- Bottom Right: Pronounce + Confused -->
      <button class="action-btn pronounce-btn" id="pronounce-btn" data-tooltip="Play Pronunciation">ğŸ—£ï¸</button>
      <button class="action-btn confused-btn-right" id="confused-btn-right" data-tooltip="I Got It Wrong (Need Extra Practice)">ğŸ˜•</button>
    </div>

    <button class="nav-btn" id="next-btn" aria-label="Next card">â€º</button>
  </div>

  <script type="module">
    // Import the wordpack module
    const MODULE_URL = 'https://some-dude-999.github.io/LPH/SpanishWords/Jsmodules/act1-foundation.js';
    
    let wordpacks = {};
    let currentDeck = [];
    let originalDeck = [];
    let currentIndex = 0;
    let isFlipped = false;
    let holdTimeout = null;
    let currentSpeed = 0.4; // Default to normal speed
    let nativeLanguage = 'english'; // Default native language
    let gameStarted = false;
    let currentWordpackKey = '';
    let currentVoice = null;
    let spanishVoices = [];

    // Learning modes
    const currentMode = 'reading'; // Locked to reading mode only
    let typingInput = ''; // User's current typing input for typing modes
    let typingDisplay = []; // Array of actual characters (always contains real word, not underscores)
    let typedPositions = new Set(); // Track which positions have been successfully typed
    let wrongAttempts = 0; // Track wrong keypresses in typing modes
    let wrongPositions = []; // Track which positions had wrong attempts (for red underlines)
    let wrongLetters = []; // Track actual letters that were typed wrong (for crossed-out display)

    // Deck change tracking (for visual indicator next to counter)
    let pendingDeckChange = 0; // +N for added cards, -N for removed cards

    // Starting card state (menu/help card)
    let isOnStartingCard = false;
    let savedIndex = 0; // Save current index when navigating to starting card

    // Track key states to prevent repeated actions when holding keys
    let keysPressed = {};

    // ===================================================================================
    // LOCAL STORAGE - Save and restore user progress
    // ===================================================================================
    const STORAGE_KEY = 'spanishFlashcardState';

    function saveState() {
      try {
        // Only save speech rate and last card pack selected, NOT deck progress
        const state = {
          voiceURI: currentVoice ? currentVoice.voiceURI : null,
          speed: currentSpeed,
          wordpackKey: currentWordpackKey
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Could not save state:', e);
      }
    }

    function loadState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.warn('Could not load state:', e);
      }
      return null;
    }

    // DOM Elements
    const wordpackSelect = document.getElementById('wordpack-select');
    const languageSelect = document.getElementById('language-select');
    const setupOverlay = document.getElementById('setup-overlay');
    const setupHelp = document.getElementById('setup-help');
    const setupVoice = document.getElementById('setup-voice');
    const setupSpeedBtns = document.querySelectorAll('.setup-speed-btn');
    const startBtn = document.getElementById('start-btn');
    const backLabel = document.getElementById('back-label');
    const flashcard = document.getElementById('flashcard');
    const spanishWord = document.getElementById('spanish-word');
    const englishWord = document.getElementById('english-word');
    const wordpackTitle = document.getElementById('wordpack-title');
    const cardCounter = document.getElementById('card-counter');
    const weatheringFront = document.getElementById('weathering-front');
    const weatheringBack = document.getElementById('weathering-back');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const gotItBtn = document.getElementById('got-it-btn');
    const confusedBtnLeft = document.getElementById('confused-btn-left');
    const confusedBtnRight = document.getElementById('confused-btn-right');
    const pronounceBtn = document.getElementById('pronounce-btn');
    const resetBtn = document.getElementById('reset-btn');
    const peekBtnFront = document.getElementById('peek-btn-front');
    const speedBtns = document.querySelectorAll('.speed-btn'); // Includes both setup and menu buttons
    const removedStamp = document.getElementById('removed-stamp');
    const addedStamp = document.getElementById('added-stamp');

    // Mode selector elements
    const modeBtns = document.querySelectorAll('.mode-btn');
    const modeReading = document.getElementById('mode-reading');
    const modeListening = document.getElementById('mode-listening');
    const modeSpeaking = document.getElementById('mode-speaking');
    const modeWriting = document.getElementById('mode-writing');

    // Modal elements
    const menuBtn = document.getElementById('menu-btn');
    const menuModal = document.getElementById('menu-modal');
    const menuClose = document.getElementById('menu-close');
    const menuWordpack = document.getElementById('menu-wordpack');
    const menuLanguage = document.getElementById('menu-language');
    const menuVoice = document.getElementById('menu-voice');
    
    // Mic and feedback elements
    const micBtnFront = document.getElementById('mic-btn-front');
    const micBtnBack = document.getElementById('mic-btn-back');
    const feedbackFront = document.getElementById('feedback-front');
    const feedbackBack = document.getElementById('feedback-back');
    const scoreFront = document.getElementById('score-front');
    const scoreBack = document.getElementById('score-back');
    const messageFront = document.getElementById('message-front');
    const messageBack = document.getElementById('message-back');
    const heardFront = document.getElementById('heard-front');
    const heardBack = document.getElementById('heard-back');
    const closeFront = document.getElementById('close-front');
    const closeBack = document.getElementById('close-back');
    
    // Speech Recognition setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.maxAlternatives = 5;
    }

    // Audio context for sounds
    let audioContext = null;
    
    function getAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }
    
    // ===================================================================================
    // CARD FLIP SOUND - "Cloud Nine" (Ultra Soft 10)
    // We worked REALLY hard on this sound. Tested dozens of variants to get this perfect.
    // It's soft, muffled, satisfying - like floating on clouds.
    // DO NOT DELETE THIS CODE EVER. SERIOUSLY. NEVER DELETE THIS.
    // ===================================================================================
    function playCardFlipSound() {
      const ctx = getAudioContext();
      const now = ctx.currentTime;
      
      const bufferSize = ctx.sampleRate * 0.23;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        const t = i / bufferSize;
        const env = Math.sin(t * Math.PI) * Math.sin(t * Math.PI * 0.38) * 0.26;
        data[i] = (Math.random() * 2 - 1) * env;
      }
      
      const source = ctx.createBufferSource();
      source.buffer = buffer;
      
      const lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.value = 400;
      
      const lp2 = ctx.createBiquadFilter();
      lp2.type = 'lowpass';
      lp2.frequency.value = 580;
      
      const gain = ctx.createGain();
      gain.gain.value = 1.2; // Much louder - increased from 0.7

      source.connect(lp);
      lp.connect(lp2);
      lp2.connect(gain);
      gain.connect(ctx.destination);
      source.start();
    }
    
    // ===================================================================================
    // BUTTON CLICK SOUND - "Click Snap J - Satisfying"
    // This is the perfect UI click sound. Balanced, satisfying snap with subtle low end.
    // DO NOT DELETE THIS SOUND ASSET. NEVER. WE MEAN IT.
    // ===================================================================================
    function playButtonClickSound() {
      const ctx = getAudioContext();
      const now = ctx.currentTime;
      
      const bufferSize = ctx.sampleRate * 0.03;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i/bufferSize, 4.5);
      }
      
      const source = ctx.createBufferSource();
      source.buffer = buffer;

      // More muffled - lower frequency lowpass filter instead of bandpass
      const lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.value = 800; // Much lower for muffled sound (was 2800 bandpass)
      lp.Q.value = 0.7;

      // Add second lowpass for extra muffling
      const lp2 = ctx.createBiquadFilter();
      lp2.type = 'lowpass';
      lp2.frequency.value = 1200;

      // Subtle low end
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(120, now); // Lower frequency
      osc.frequency.exponentialRampToValueAtTime(60, now + 0.025);

      const oscGain = ctx.createGain();
      oscGain.gain.setValueAtTime(0.05, now); // Quieter (was 0.1)
      oscGain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);

      const gain = ctx.createGain();
      gain.gain.value = 0.75; // Much louder - increased from 0.45

      source.connect(lp);
      lp.connect(lp2);
      lp2.connect(gain);
      gain.connect(ctx.destination);
      osc.connect(oscGain);
      oscGain.connect(ctx.destination);

      source.start();
      osc.start();
      osc.stop(now + 0.04);
    }

    // ===================================================================================
    // MECHANICAL KEYBOARD SOUND - Satisfying tactile click (kept for future reference)
    // ===================================================================================
    function playKeyboardSound() {
      const ctx = getAudioContext();
      const now = ctx.currentTime;

      const bufferSize = ctx.sampleRate * 0.04;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);

      for (let i = 0; i < bufferSize; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i/bufferSize, 5);
      }

      const source = ctx.createBufferSource();
      source.buffer = buffer;

      const hp = ctx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 2000;

      const bp = ctx.createBiquadFilter();
      bp.type = 'bandpass';
      bp.frequency.value = 4500;
      bp.Q.value = 2;

      const gain = ctx.createGain();
      gain.gain.value = 0.3;

      source.connect(hp);
      hp.connect(bp);
      bp.connect(gain);
      gain.connect(ctx.destination);
      source.start();
    }

    // ===================================================================================
    // MECHANICAL KEYBOARD TYPING SOUND - Satisfying clicky mechanical keyboard
    // ===================================================================================
    function playScribbleSound() {
      const ctx = getAudioContext();
      const now = ctx.currentTime;

      // Very short duration for crisp mechanical click (0.015-0.025 seconds)
      const duration = 0.015 + Math.random() * 0.01;
      const bufferSize = ctx.sampleRate * duration;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);

      // Generate sharp click noise
      for (let i = 0; i < bufferSize; i++) {
        const envelope = Math.pow(1 - i/bufferSize, 8); // Very sharp decay for crisp click
        const noise = (Math.random() * 2 - 1);
        data[i] = noise * envelope;
      }

      const source = ctx.createBufferSource();
      source.buffer = buffer;

      // High frequency for mechanical click (2000-3500 Hz)
      const bp1 = ctx.createBiquadFilter();
      bp1.type = 'bandpass';
      bp1.frequency.value = 2000 + Math.random() * 1500; // 2000-3500 Hz - clicky range
      bp1.Q.value = 4.0; // Very high Q for sharp, defined click

      // Mid frequency for body (1000-1500 Hz)
      const bp2 = ctx.createBiquadFilter();
      bp2.type = 'bandpass';
      bp2.frequency.value = 1000 + Math.random() * 500; // 1000-1500 Hz - body
      bp2.Q.value = 2.5;

      // Remove low mud
      const hp = ctx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 400;

      // Moderate volume for satisfying click
      const gain = ctx.createGain();
      gain.gain.value = 0.35 + Math.random() * 0.1; // 0.35-0.45 volume

      source.connect(hp);
      hp.connect(bp1);
      bp1.connect(bp2);
      bp2.connect(gain);
      gain.connect(ctx.destination);
      source.start();
    }

    // ===================================================================================
    // MODE SWITCHING AND DISPLAY FUNCTIONS
    // ===================================================================================

    // Normalize character for comparison (remove accents, lowercase)
    function normalizeChar(char) {
      return char.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }

    // Navigate to starting card (menu/help card)
    function showStartingCard(showBack = false) {
      if (!isOnStartingCard && currentDeck.length > 0) {
        savedIndex = currentIndex;
      }
      isOnStartingCard = true;

      // Update titles
      wordpackTitle.textContent = 'Spanish Flashcards';
      cardCounter.textContent = 'Choose Lesson to Begin Studying';

      // Render menu card (looks identical to a flashcard)
      renderMenuCard();

      // Unflip card face if currently flipped
      if (isFlipped) {
        flashcard.classList.remove('flipped');
        isFlipped = false;
      }

      // Flip to back if help was requested
      if (showBack) {
        setTimeout(() => flipCard(), 100);
      }
    }

    // Return from starting card to saved position
    function exitStartingCard() {
      if (!isOnStartingCard) return;
      isOnStartingCard = false;

      currentIndex = savedIndex;
      updateWordpackTitle(); // Restore wordpack title
      updateDisplay();
    }

    // Render the menu card (looks like a regular flashcard)
    function renderMenuCard() {
      // Front: Menu/Settings (styled like Spanish side)
      spanishWord.innerHTML = `
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 30px;">âš™ï¸ Settings</div>

        <div style="font-size: 1.3rem; text-align: left; max-width: 500px; margin: 0 auto; line-height: 2;">
          <div style="margin: 20px 0;">
            <div style="font-weight: bold; margin-bottom: 8px;">Wordpack</div>
            <select id="menu-wordpack" style="width: 100%; padding: 10px; font-size: 1.1rem; border-radius: 5px; border: 2px solid #8B7355; background: #F5E6D3;">
              <option value="">-- Select --</option>
            </select>
          </div>

          <div style="margin: 20px 0;">
            <div style="font-weight: bold; margin-bottom: 8px;">I speak</div>
            <select id="menu-language" style="width: 100%; padding: 10px; font-size: 1.1rem; border-radius: 5px; border: 2px solid #8B7355; background: #F5E6D3;">
              <option value="">-- Select --</option>
              <option value="english">English</option>
              <option value="chinese">ä¸­æ–‡</option>
              <option value="portuguese">PortuguÃªs</option>
            </select>
          </div>

          <div style="margin: 20px 0;">
            <div style="font-weight: bold; margin-bottom: 8px;">Speech Speed</div>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="menu-speed-btn" data-speed="0.2" style="padding: 10px 20px; font-size: 1.2rem; border-radius: 5px; border: 2px solid #8B7355; background: #F5E6D3; cursor: pointer;">ğŸ¢</button>
              <button class="menu-speed-btn active" data-speed="0.6" style="padding: 10px 20px; font-size: 1.2rem; border-radius: 5px; border: 2px solid #8B7355; background: #8B7355; color: #F5E6D3; cursor: pointer;">ğŸš¶</button>
              <button class="menu-speed-btn" data-speed="1.0" style="padding: 10px 20px; font-size: 1.2rem; border-radius: 5px; border: 2px solid #8B7355; background: #F5E6D3; cursor: pointer;">ğŸ‡</button>
            </div>
          </div>

          <button onclick="exitStartingCard()" style="width: 100%; padding: 15px; margin-top: 30px; font-size: 1.5rem; background: #8B7355; color: #F5E6D3; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
            â† Back to Practice
          </button>
        </div>
      `;
      spanishWord.className = 'card-word';

      // Back: Help/Instructions (styled like English translation side)
      englishWord.innerHTML = `
        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 20px;">â“ How to Use</div>

        <div style="font-size: 1.1rem; text-align: left; max-width: 500px; margin: 0 auto; line-height: 1.8;">
          <div style="margin-bottom: 15px;">
            <strong>ğŸ“– Reading Mode:</strong> Spanish word â†’ flip to see translation
          </div>

          <div style="margin-bottom: 15px;">
            <strong>ğŸ‘‚ Listening Mode:</strong> Hear Spanish â†’ type what you heard
          </div>

          <div style="margin-bottom: 15px;">
            <strong>ğŸ’¬ Speaking Mode:</strong> See Spanish â†’ say it out loud (Space to record)
          </div>

          <div style="margin-bottom: 15px;">
            <strong>âœï¸ Writing Mode:</strong> See English â†’ type Spanish translation
          </div>

          <div style="margin-bottom: 15px;">
            <strong>Controls:</strong><br>
            â€¢ Click card or â†“ to flip<br>
            â€¢ â† â†’ to navigate<br>
            â€¢ Space: Hear pronunciation (reading) / Record speech (speaking) / Type practice (listening/writing)<br>
            â€¢ Type letters in listening/writing modes
          </div>

          <div style="margin-bottom: 15px;">
            <strong>Buttons:</strong><br>
            â€¢ ğŸ‘Œ Remove mastered card<br>
            â€¢ ğŸ˜• Add 2 practice copies<br>
            â€¢ â†º Reset all cards
          </div>
        </div>
      `;
      englishWord.className = 'card-word';

      // Populate selectors after render
      setTimeout(() => {
        const menuWordpack = document.getElementById('menu-wordpack');
        const menuLanguage = document.getElementById('menu-language');

        if (menuWordpack && wordpackSelect) {
          menuWordpack.innerHTML = wordpackSelect.innerHTML;
          menuWordpack.value = currentWordpackKey;

          menuWordpack.addEventListener('change', (e) => {
            currentWordpackKey = e.target.value;
            wordpackSelect.value = e.target.value;
            if (gameStarted) {
              initializeDeck(currentWordpackKey);
            }
            saveState();
          });
        }

        if (menuLanguage) {
          menuLanguage.value = nativeLanguage;

          menuLanguage.addEventListener('change', (e) => {
            nativeLanguage = e.target.value;
            languageSelect.value = e.target.value;
            updateBackLabel();
            if (gameStarted) {
              initializeDeck(currentWordpackKey);
            }
            saveState();
          });
        }

        // Speed buttons
        const speedBtns = document.querySelectorAll('.menu-speed-btn');
        speedBtns.forEach(btn => {
          if (parseFloat(btn.dataset.speed) === currentSpeed) {
            btn.style.background = '#8B7355';
            btn.style.color = '#F5E6D3';
          }
          btn.addEventListener('click', () => {
            currentSpeed = parseFloat(btn.dataset.speed);
            speedBtns.forEach(b => {
              b.style.background = '#F5E6D3';
              b.style.color = '#2C1810';
            });
            btn.style.background = '#8B7355';
            btn.style.color = '#F5E6D3';
            saveState();
          });
        });
      }, 0);
    }

    // Switch to a different learning mode
    function switchMode(newMode) {
      if (currentMode === newMode) return;

      currentMode = newMode;

      // Update active button
      modeBtns.forEach(btn => btn.classList.remove('active'));
      if (newMode === 'reading') modeReading.classList.add('active');
      if (newMode === 'listening') modeListening.classList.add('active');
      if (newMode === 'speaking') modeSpeaking.classList.add('active');
      if (newMode === 'writing') modeWriting.classList.add('active');

      // Completely reset pack as if starting new game in this mode
      // (Reset from original deck, not modified current deck)
      if (originalDeck.length > 0) {
        currentDeck = shuffleArray([...originalDeck]);
        currentIndex = 0;
      }

      // Reset flip state
      if (isFlipped) {
        flashcard.classList.remove('flipped');
        isFlipped = false;
      }

      // Reset deck change indicator
      pendingDeckChange = 0;

      // Initialize typing display for listening and writing modes
      if ((newMode === 'listening' || newMode === 'writing') && currentDeck.length > 0) {
        initializeTypingDisplay();
      }

      updateDisplay();

      // Auto-pronounce Spanish in listening mode only (not writing - user needs to translate)
      if (newMode === 'listening' && currentDeck.length > 0) {
        setTimeout(() => speakSpanish(), 300);
      }

      // Save state (only saves speech rate and pack selection, not deck progress)
      saveState();
    }

    // Initialize typing display for listening and writing modes
    function initializeTypingDisplay() {
      const word = currentDeck[currentIndex].spanish;
      typingInput = '';
      // Store actual characters (not underscores) to preserve natural layout
      typingDisplay = word.split('');
      typedPositions = new Set(); // Reset typed positions (starts empty)
      wrongAttempts = 0; // Reset wrong attempts counter
      wrongPositions = []; // Reset wrong positions array
      wrongLetters = []; // Reset wrong letters array
    }

    // Add duplicate cards to current deck for extra practice
    function addDuplicateCards(count) {
      if (currentDeck.length === 0 || count === 0) return;

      const currentCard = currentDeck[currentIndex];

      // Insert cards randomly in the remaining deck, skipping next 2 cards if possible
      for (let i = 0; i < count; i++) {
        const duplicate = { ...currentCard };

        // Calculate remaining cards after current card
        const remainingCards = currentDeck.length - (currentIndex + 1);

        if (remainingCards > 2) {
          // If more than 2 cards remaining, insert randomly after the next 2 cards
          const randomOffset = Math.floor(Math.random() * (remainingCards - 2)) + 3;
          currentDeck.splice(currentIndex + randomOffset, 0, duplicate);
        } else if (remainingCards > 0) {
          // If 1-2 cards remaining, insert right after current card
          currentDeck.splice(currentIndex + 1, 0, duplicate);
        } else {
          // If no cards remaining, add to end
          currentDeck.push(duplicate);
        }
      }

      // Track deck change for visual indicator
      pendingDeckChange += count;

      // Update display to show indicator while stamp is visible
      updateDisplay();

      // Show "Extra Practice" stamp (1.5 seconds)
      const addedStamp = document.getElementById('added-stamp');
      addedStamp.classList.add('visible');
      setTimeout(() => {
        addedStamp.classList.remove('visible');
        pendingDeckChange = 0; // Clear indicator after stamp
      }, 1500);
    }

    // Handle typing input for listening and writing modes
    function handleTypingInput(key) {
      if ((currentMode !== 'listening' && currentMode !== 'writing') || currentDeck.length === 0) return;

      const word = currentDeck[currentIndex].spanish;
      const targetChars = word.split('');

      // Find next unfilled position (first position not in typedPositions)
      let nextPos = 0;
      for (let i = 0; i < typingDisplay.length; i++) {
        if (!typedPositions.has(i) && typingDisplay[i] !== ' ') {
          nextPos = i;
          break;
        }
        if (i === typingDisplay.length - 1) {
          // Already completed
          return;
        }
      }

      // Skip spaces and mark them as typed
      while (nextPos < targetChars.length && targetChars[nextPos] === ' ') {
        typedPositions.add(nextPos);
        nextPos++;
      }

      if (nextPos >= targetChars.length) return;

      // Check if key matches (case and accent insensitive)
      const normalizedKey = normalizeChar(key);
      const normalizedTarget = normalizeChar(targetChars[nextPos]);

      if (normalizedKey === normalizedTarget) {
        // Correct! Mark position as typed
        typedPositions.add(nextPos);
        playScribbleSound(); // Felt pen writing sound
        updateDisplay();

        // Check if word is complete (all non-space positions typed)
        const totalNonSpaceChars = targetChars.filter(c => c !== ' ').length;
        if (typedPositions.size >= totalNonSpaceChars) {
          // Word completed!
          // 0-1 wrong = correct (show green stamp and remove card)
          // 2 wrong = 1 penalty card
          // 3+ wrong = 2 penalty cards (capped)

          if (wrongAttempts <= 1) {
            // Correct! Show green stamp and remove card automatically
            playCardFlipSound();
            pendingDeckChange = -1; // Track deck change for visual indicator
            updateDisplay(); // Show indicator while stamp is visible
            removedStamp.classList.add('visible');

            setTimeout(() => {
              removedStamp.classList.remove('visible');

              // Remove card from deck
              if (currentDeck.length <= 1) {
                currentDeck = [];
              } else {
                currentDeck.splice(currentIndex, 1);
                if (currentIndex >= currentDeck.length) {
                  currentIndex = 0;
                }
              }

              // Clear pending change
              pendingDeckChange = 0;

              // Re-initialize typing for next card
              if (currentMode === 'listening' || currentMode === 'writing') {
                initializeTypingDisplay();
              }
              updateDisplay();
              saveState();

              // Auto-pronounce in listening mode
              if (currentMode === 'listening' && currentDeck.length > 0) {
                setTimeout(() => speakSpanish(), 300);
              }
            }, 1500); // 1.5 seconds
          } else {
            // Wrong - add penalty cards
            const penaltyCards = Math.min(wrongAttempts - 1, 2);
            if (penaltyCards > 0) {
              addDuplicateCards(penaltyCards);
            }

            // Auto-advance after stamp duration (1600ms > 1500ms stamp)
            setTimeout(() => {
              if (currentMode === 'listening' || currentMode === 'writing') {
                moveToNextCard();
              }
            }, 1600);
          }
        }
      } else {
        // Wrong key pressed - mark position as wrong, increment counter, and track wrong letter
        playScribbleSound(); // Play scribble sound for any key press
        if (!wrongPositions.includes(nextPos)) {
          wrongPositions.push(nextPos);
        }
        wrongAttempts++;
        // Store wrong letter with its style (lowercase, random rotation/scale - set once, never changes)
        wrongLetters.push({
          letter: key.toLowerCase(), // Case-insensitive
          rotation: -8 + Math.random() * 16, // -8deg to +8deg
          scale: 0.95 + Math.random() * 0.1, // 0.95 to 1.05
          xRotation: -5 + Math.random() * 10 // -5deg to +5deg for X mark
        });
        updateDisplay(); // Update to show red color and wrong indicators
      }
    }

    // Check if current word is complete in writing mode
    function isWritingComplete() {
      return !typingDisplay.includes('_');
    }

    // Load Spanish voices
    function loadVoices() {
      spanishVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('es'));
      populateVoiceSelector();
    }

    function populateVoiceSelector() {
      // Populate both setup and menu voice selectors
      const voiceSelectors = [setupVoice];
      if (menuVoice) voiceSelectors.push(menuVoice);

      voiceSelectors.forEach(selector => {
        selector.innerHTML = '<option value="">Default</option>';
        spanishVoices.forEach((voice, idx) => {
          const option = document.createElement('option');
          option.value = voice.voiceURI;
          option.textContent = `${voice.name} (${voice.lang})`;
          selector.appendChild(option);
        });
      });

      // Restore saved voice
      const savedState = loadState();
      if (savedState && savedState.voiceURI) {
        setupVoice.value = savedState.voiceURI;
        if (menuVoice) menuVoice.value = savedState.voiceURI;
        currentVoice = spanishVoices.find(v => v.voiceURI === savedState.voiceURI) || null;
      }
    }

    // Load voices when available
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    // Load the module dynamically
    async function loadWordpacks() {
      try {
        const module = await import(MODULE_URL);
        wordpacks = module;
        populateWordpackSelector();
        restoreSavedState();

        // Auto-start the game with first pack and English
        // Use setTimeout to ensure DOM is fully ready
        setTimeout(() => {
          // Force set values to ensure they're correct
          if (!wordpackSelect.value) {
            const firstPack = Object.keys(wordpacks)[0];
            if (firstPack) wordpackSelect.value = firstPack;
          }
          if (!languageSelect.value) {
            languageSelect.value = 'english';
          }

          startGame();
        }, 200);
      } catch (error) {
        console.error('Failed to load wordpacks:', error);
        wordpackSelect.innerHTML = '<option value="">Failed to load wordpacks</option>';
      }
    }

    // Populate the dropdown with wordpack options
    function populateWordpackSelector() {
      // Setup page dropdowns
      wordpackSelect.innerHTML = '';
      menuWordpack.innerHTML = '';
      
      // Collect and sort wordpacks by their wordpack number
      const sortedPacks = Object.entries(wordpacks)
        .filter(([key, pack]) => pack.meta && pack.words && pack.meta.wordpack)
        .sort((a, b) => a[1].meta.wordpack - b[1].meta.wordpack);
      
      for (const [key, pack] of sortedPacks) {
        const option1 = document.createElement('option');
        option1.value = key;
        option1.textContent = `${pack.meta.wordpack}. ${pack.meta.english}`;
        wordpackSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = key;
        option2.textContent = `${pack.meta.wordpack}. ${pack.meta.english}`;
        menuWordpack.appendChild(option2);
      }
      
      // Auto-select first wordpack
      if (sortedPacks.length > 0) {
        wordpackSelect.value = sortedPacks[0][0];
        menuWordpack.value = sortedPacks[0][0];
      }
      
      // Auto-select first language (English)
      languageSelect.value = 'english';
      menuLanguage.value = 'english';
      
      checkSetupValid();
    }

    // Restore saved state from localStorage
    function restoreSavedState() {
      const savedState = loadState();
      if (!savedState) return;

      // Only restore speech rate and last card pack selected (NOT deck progress)
      if (savedState.speed) {
        currentSpeed = savedState.speed;
        // Restore speed to all speed buttons (setup and menu)
        speedBtns.forEach(btn => {
          btn.classList.toggle('active', parseFloat(btn.dataset.speed) === currentSpeed);
        });
        setupSpeedBtns.forEach(btn => {
          btn.classList.toggle('active', parseFloat(btn.dataset.speed) === currentSpeed);
        });
      }

      // Restore last selected wordpack
      if (savedState.wordpackKey && wordpacks[savedState.wordpackKey]) {
        currentWordpackKey = savedState.wordpackKey;
        wordpackSelect.value = savedState.wordpackKey;
        if (menuWordpack) {
          menuWordpack.value = savedState.wordpackKey;
        }
      }

      // Voice will be restored in populateVoiceSelector
    }

    function updateBackLabel() {
      // Card labels have been removed, this function is no longer needed
      // Kept for compatibility with existing code that calls it
      if (!backLabel) return;

      const labels = {
        'english': 'English',
        'chinese': 'ä¸­æ–‡',
        'portuguese': 'PortuguÃªs'
      };
      backLabel.textContent = labels[nativeLanguage] || 'English';
    }

    // Shuffle array (Fisher-Yates algorithm)
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Initialize deck from selected wordpack
    function initializeDeck(packKey) {
      if (!packKey || !wordpacks[packKey]) {
        currentDeck = [];
        originalDeck = [];
        updateDisplay();
        return;
      }

      const pack = wordpacks[packKey];
      // Language index mapping: spanish=0, english=1, chinese=2, pinyin=3, portuguese=4
      const langIndex = {
        'english': 1,
        'chinese': 2,
        'portuguese': 4
      };
      const nativeIndex = langIndex[nativeLanguage] || 1;
      
      // Create card objects with spanish (index 0) and native language translation
      originalDeck = pack.words.map((word, idx) => ({
        id: `${packKey}-${idx}`,
        spanish: word[0],
        translation: word[nativeIndex]
      }));
      
      currentDeck = shuffleArray([...originalDeck]);
      currentIndex = 0;
      updateDisplay();
    }

    // Restart current wordpack
    function restartCurrentPack() {
      playButtonClickSound();
      if (originalDeck.length > 0) {
        currentDeck = shuffleArray([...originalDeck]);
        currentIndex = 0;
        if (currentMode === 'listening' || currentMode === 'writing') {
          initializeTypingDisplay();
        }
        updateDisplay();
        saveState();
      }
    }

    // Go to next wordpack
    function goToNextPack() {
      playButtonClickSound();
      const packs = Object.keys(wordpacks);
      if (packs.length === 0) return;

      const currentPackIndex = packs.indexOf(currentWordpackKey);
      const nextPackIndex = (currentPackIndex + 1) % packs.length;
      const nextPackKey = packs[nextPackIndex];

      currentWordpackKey = nextPackKey;
      wordpackSelect.value = nextPackKey;
      initializeDeck(nextPackKey);
      updateWordpackTitle();
      saveState();
    }

    // Generate random weathering pattern for a card
    function generateWeathering(seed) {
      // Use card ID as seed for consistent random pattern per card
      const random = (s) => {
        const x = Math.sin(s) * 10000;
        return x - Math.floor(x);
      };

      // Generate stronger sun-faded edges (more obvious)
      const topFade = 15 + random(seed) * 10; // 15-25%
      const rightFade = 15 + random(seed + 1) * 10;
      const bottomFade = 15 + random(seed + 2) * 10;
      const leftFade = 15 + random(seed + 3) * 10;

      // Vary the color tint (brownish/sepia tones)
      const redTint = 101 + Math.floor(random(seed + 4) * 20); // 101-120
      const greenTint = 67 + Math.floor(random(seed + 5) * 15); // 67-82
      const blueTint = 33 + Math.floor(random(seed + 6) * 10); // 33-43

      // Vary the edge intensity (stronger)
      const edgeIntensity = 0.18 + random(seed + 7) * 0.12; // 0.18-0.30

      // Overall card color variation (subtle)
      const overallIntensity = 0.03 + random(seed + 8) * 0.04; // 0.03-0.07

      // Random positions for color variation splotches
      const spot1X = 20 + random(seed + 9) * 30; // 20-50%
      const spot1Y = 20 + random(seed + 10) * 30;
      const spot2X = 50 + random(seed + 11) * 30; // 50-80%
      const spot2Y = 50 + random(seed + 12) * 30;
      const spot3X = 30 + random(seed + 13) * 40; // 30-70%
      const spot3Y = 60 + random(seed + 14) * 30;

      const gradients = [
        // Overall card color variations (subtle splotches across entire card)
        `radial-gradient(ellipse 60% 50% at ${spot1X}% ${spot1Y}%, rgba(${redTint}, ${greenTint}, ${blueTint}, ${overallIntensity}) 0%, transparent 60%)`,
        `radial-gradient(ellipse 50% 60% at ${spot2X}% ${spot2Y}%, rgba(${redTint + 5}, ${greenTint + 3}, ${blueTint + 2}, ${overallIntensity * 0.8}) 0%, transparent 55%)`,
        `radial-gradient(ellipse 55% 45% at ${spot3X}% ${spot3Y}%, rgba(${redTint - 5}, ${greenTint - 2}, ${blueTint}, ${overallIntensity * 0.9}) 0%, transparent 50%)`,
        // Stronger sun-faded edges
        `linear-gradient(to bottom, rgba(${redTint}, ${greenTint}, ${blueTint}, ${edgeIntensity}) 0%, transparent ${topFade}%)`,
        `linear-gradient(to left, rgba(${redTint}, ${greenTint}, ${blueTint}, ${edgeIntensity}) 0%, transparent ${rightFade}%)`,
        `linear-gradient(to top, rgba(${redTint}, ${greenTint}, ${blueTint}, ${edgeIntensity}) 0%, transparent ${bottomFade}%)`,
        `linear-gradient(to right, rgba(${redTint}, ${greenTint}, ${blueTint}, ${edgeIntensity}) 0%, transparent ${leftFade}%)`
      ];

      return gradients.join(', ');
    }

    // Render typing display with word grouping (keeps words together, wraps between words)
    function renderTypingDisplay() {
      let html = '';
      let currentWord = [];
      let currentWordStartIdx = 0;

      for (let idx = 0; idx < typingDisplay.length; idx++) {
        const actualChar = typingDisplay[idx]; // Always the real character

        if (actualChar === ' ') {
          // End of word - wrap accumulated chars in nowrap span
          if (currentWord.length > 0) {
            html += `<span style="white-space: nowrap;">${currentWord.join('')}</span>`;
            currentWord = [];
          }
          // Add space between words (browser handles line breaks naturally without trailing/leading spaces)
          html += ' ';
          currentWordStartIdx = idx + 1;
        } else {
          // Always render actual character to preserve layout
          // For untyped positions, show underscore overlay (character is invisible but takes space)
          const isTyped = typedPositions.has(idx);
          const wrongClass = wrongPositions.includes(idx) ? 'wrong' : '';

          if (isTyped) {
            // Typed: show actual character
            currentWord.push(`<span class="typing-char ${wrongClass}">${actualChar}</span>`);
          } else {
            // Untyped: invisible character with underscore overlay (preserves natural spacing)
            currentWord.push(`<span class="typing-char ${wrongClass}" style="position: relative; display: inline-block;"><span style="opacity: 0;">${actualChar}</span><span style="position: absolute; top: 0; left: 0;">_</span></span>`);
          }
        }
      }

      // Add remaining word
      if (currentWord.length > 0) {
        html += `<span style="white-space: nowrap;">${currentWord.join('')}</span>`;
      }

      return html;
    }

    // Update the card display
    function updateDisplay() {
      // Starting card is shown/hidden by showStartingCard/exitStartingCard
      // Don't update card content when on starting card
      if (isOnStartingCard) {
        return;
      }

      if (currentDeck.length === 0) {
        // Show completion screen
        cardCounter.textContent = 'Pack Complete!';
        spanishWord.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 30px;">ğŸ‰ Good Job! ğŸ‰</div>
          <div style="font-size: 1.5rem; margin-bottom: 40px;">You've completed this wordpack!</div>
          <div style="display: flex; gap: 20px; justify-content: center;">
            <button onclick="restartCurrentPack()" style="padding: 15px 30px; font-size: 1.3rem; background: #8B7355; color: #F5E6D3; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
              â†º Study Again
            </button>
            <button onclick="goToNextPack()" style="padding: 15px 30px; font-size: 1.3rem; background: #7A6347; color: #F5E6D3; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
              â†’ Next Pack
            </button>
          </div>
        `;
        spanishWord.className = 'card-word';
        englishWord.textContent = '';
        return;
      }

      const card = currentDeck[currentIndex];

      // Display counter with pending change indicator
      let counterText = `Card ${currentIndex + 1} of ${currentDeck.length}`;
      if (pendingDeckChange !== 0) {
        // Add mini stamp indicator (uses same .stamp-base styling as card stamps, fully opaque for visibility)
        const changeSign = pendingDeckChange > 0 ? '+' : '';
        const changeColor = pendingDeckChange > 0 ? 'rgba(211, 47, 47, 0.7)' : 'rgba(56, 142, 60, 0.7)'; // red for +, green for -
        const rotateVar = -2 + Math.random() * 4; // -2deg to +2deg (subtle rotation)
        // Using inline class reference to .stamp-base properties
        cardCounter.innerHTML = `${counterText} <span class="stamp-base" style="display: inline-block; font-size: 1.3rem; color: transparent; border-color: ${changeColor}; -webkit-text-stroke: 2px ${changeColor}; text-stroke: 2px ${changeColor}; transform: rotate(${rotateVar}deg); margin-left: 8px; padding: 4px 12px; opacity: 1;">${changeSign}${pendingDeckChange}</span>`;
      } else {
        cardCounter.textContent = counterText;
      }

      // Get indicator elements (positioned at card corners, not inside card-word)
      const wrongLettersFront = document.getElementById('wrong-letters-front');
      const wrongCountFront = document.getElementById('wrong-count-front');

      // Mode-specific display
      if (currentMode === 'reading') {
        // READING MODE - Purpose: Learn to read Spanish and understand meaning
        // Front: Spanish word | Back: English translation
        spanishWord.textContent = card.spanish;
        spanishWord.className = 'card-word';
        englishWord.innerHTML = `<div class="translation-text">${card.translation}</div>`;
        englishWord.className = 'card-word';
        // Clear indicators
        wrongLettersFront.innerHTML = '';
        wrongCountFront.innerHTML = '';
      } else if (currentMode === 'listening') {
        // LISTENING MODE - Purpose: Learn to understand spoken Spanish and spell it
        // Front: Hear Spanish audio + type what you hear | Back: Spanish word + English translation
        // Update wrong indicators (positioned at card corners) - use stored variations (don't recalc)
        // Get unique letters (by letter property, case-insensitive)
        const seenLetters = new Set();
        const uniqueWrongLetters = wrongLetters.filter(item => {
          if (seenLetters.has(item.letter)) {
            return false;
          }
          seenLetters.add(item.letter);
          return true;
        });
        wrongLettersFront.innerHTML = uniqueWrongLetters.length > 0
          ? uniqueWrongLetters.map(item => {
              // Use stored rotation/scale values - never recalculate (real writing doesn't move!)
              return `<span style="position: relative; display: inline-block; margin-right: 15px; transform: scale(${item.scale}) rotate(${item.rotation}deg);"><span style="color: #2C1810;">${item.letter}</span><span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(${item.xRotation}deg); color: #D32F2F; font-size: 0.7em; font-weight: bold; opacity: 0.7;">âœ—</span></span>`;
            }).join('')
          : '';
        const countRotate = -2 + Math.random() * 4; // -2deg to +2deg
        const countScale = 0.95 + Math.random() * 0.1; // 0.95 to 1.05
        wrongCountFront.innerHTML = wrongAttempts > 0
          ? `<span style="display: inline-block; transform: scale(${countScale}) rotate(${countRotate}deg);">-${wrongAttempts}</span>`
          : '';
        // Update card content (no indicators embedded here)
        spanishWord.innerHTML = `<div class="typing-display">${renderTypingDisplay()}</div>`;
        spanishWord.className = 'card-word';
        englishWord.innerHTML = `${card.spanish}<br><div class="translation-text">${card.translation}</div>`;
        englishWord.className = 'card-word';
      } else if (currentMode === 'writing') {
        // WRITING MODE - Purpose: Learn to write/spell Spanish from English
        // Front: English word + type Spanish translation | Back: Correct Spanish word
        // Update wrong indicators (positioned at card corners) - use stored variations (don't recalc)
        // Get unique letters (by letter property, case-insensitive)
        const seenLetters = new Set();
        const uniqueWrongLetters = wrongLetters.filter(item => {
          if (seenLetters.has(item.letter)) {
            return false;
          }
          seenLetters.add(item.letter);
          return true;
        });
        wrongLettersFront.innerHTML = uniqueWrongLetters.length > 0
          ? uniqueWrongLetters.map(item => {
              // Use stored rotation/scale values - never recalculate (real writing doesn't move!)
              return `<span style="position: relative; display: inline-block; margin-right: 15px; transform: scale(${item.scale}) rotate(${item.rotation}deg);"><span style="color: #2C1810;">${item.letter}</span><span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(${item.xRotation}deg); color: #D32F2F; font-size: 0.7em; font-weight: bold; opacity: 0.7;">âœ—</span></span>`;
            }).join('')
          : '';
        const countRotate = -2 + Math.random() * 4; // -2deg to +2deg
        const countScale = 0.95 + Math.random() * 0.1; // 0.95 to 1.05
        wrongCountFront.innerHTML = wrongAttempts > 0
          ? `<span style="display: inline-block; transform: scale(${countScale}) rotate(${countRotate}deg);">-${wrongAttempts}</span>`
          : '';
        // Update card content (no indicators embedded here)
        spanishWord.innerHTML = `<div class="translation-text">${card.translation}</div><div style="margin: 10px 0;"></div><div class="typing-display">${renderTypingDisplay()}</div>`;
        spanishWord.className = 'card-word';
        englishWord.textContent = card.spanish;
        englishWord.className = 'card-word';
      } else if (currentMode === 'speaking') {
        // SPEAKING MODE - Purpose: Learn to pronounce Spanish correctly
        // Front: Spanish word + microphone button | Back: English translation
        spanishWord.textContent = card.spanish;
        spanishWord.className = 'card-word';
        englishWord.innerHTML = `<div class="translation-text">${card.translation}</div>`;
        englishWord.className = 'card-word';
        // Clear indicators
        wrongLettersFront.innerHTML = '';
        wrongCountFront.innerHTML = '';
      }

      // Show/hide mic button based on mode
      const micBtnFrontEl = document.getElementById('mic-btn-front');
      const micBtnBackEl = document.getElementById('mic-btn-back');
      if (currentMode === 'speaking') {
        micBtnFrontEl.style.display = 'block';
        micBtnBackEl.style.display = 'block';
      } else {
        micBtnFrontEl.style.display = 'none';
        micBtnBackEl.style.display = 'none';
      }

      // Show/hide action buttons based on mode (only show in reading mode)
      const gotItBtnEl = document.getElementById('got-it-btn');
      const confusedBtnLeftEl = document.getElementById('confused-btn-left');
      const confusedBtnRightEl = document.getElementById('confused-btn-right');
      if (currentMode === 'reading') {
        gotItBtnEl.style.display = 'flex';
        confusedBtnLeftEl.style.display = 'flex';
        confusedBtnRightEl.style.display = 'flex';
      } else {
        gotItBtnEl.style.display = 'none';
        confusedBtnLeftEl.style.display = 'none';
        confusedBtnRightEl.style.display = 'none';
      }

      // Show/hide navigation arrows based on mode (only show in reading mode - others auto-advance)
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      if (currentMode === 'reading') {
        prevBtn.style.display = 'flex';
        nextBtn.style.display = 'flex';
      } else {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }

      // Apply random weathering based on card ID
      const seed = card.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      weatheringFront.style.background = generateWeathering(seed);
      weatheringBack.style.background = generateWeathering(seed + 1000);

      // Reset flip state
      flashcard.classList.remove('flipped');
      isFlipped = false;
    }

    // ============================================================
    // KEY FEATURE: Auto-pronounce Spanish word in listening mode
    // - On card navigation (prev/next): auto-pronounce
    // - Helps users learn pronunciation through repetition
    // ============================================================

    // Navigate to previous card (with wrap-around)
    function goToPrevious() {
      if (currentDeck.length === 0) return;
      speechSynthesis.cancel(); // Stop speech on card navigation
      playCardFlipSound();
      currentIndex = (currentIndex - 1 + currentDeck.length) % currentDeck.length;
      if (currentMode === 'listening' || currentMode === 'writing') {
        initializeTypingDisplay();
      }
      updateDisplay();
      saveState();

      // Auto-read in listening mode (helps learn pronunciation)
      if (currentMode === 'listening') {
        setTimeout(() => speakSpanish(), 300);
      }
    }

    // Navigate to next card (with wrap-around)
    function goToNext() {
      if (currentDeck.length === 0) return;
      speechSynthesis.cancel(); // Stop speech on card navigation
      playCardFlipSound();
      currentIndex = (currentIndex + 1) % currentDeck.length;
      if (currentMode === 'listening' || currentMode === 'writing') {
        initializeTypingDisplay();
      }
      updateDisplay();
      saveState();

      // Auto-read in listening mode (helps learn pronunciation)
      if (currentMode === 'listening') {
        setTimeout(() => speakSpanish(), 300);
      }
    }

    // Move to next card (for typing mode completion)
    function moveToNextCard() {
      if (currentDeck.length === 0) return;
      playCardFlipSound();
      currentIndex = (currentIndex + 1) % currentDeck.length;
      if (currentMode === 'listening' || currentMode === 'writing') {
        initializeTypingDisplay();
      }
      updateDisplay();
      saveState();

      // Auto-read in listening mode only (not writing - user needs to translate)
      if (currentMode === 'listening') {
        setTimeout(() => speakSpanish(), 300);
      }
    }

    // ============================================================
    // KEY FEATURE: Auto-pronounce Spanish word on back reveal
    // - When flipping to back (arrow down): pronounce in ALL modes
    // - Helps users associate written word with pronunciation
    // ============================================================

    // Flip card
    function flipCard() {
      // Don't stop speech - let it continue while viewing back
      flashcard.classList.add('flipped');
      isFlipped = true;

      // Auto-pronounce when flipping to back (ALL modes, except help/tutorial card)
      if (currentDeck.length > 0 && !isOnStartingCard) {
        setTimeout(() => speakSpanish(), 300);
      }
    }

    // Unflip card
    function unflipCard() {
      // Don't stop speech - let it continue while viewing front
      flashcard.classList.remove('flipped');
      isFlipped = false;
    }

    // Remove current card (Got it!)
    function removeCurrentCard() {
      if (currentDeck.length <= 1) {
        currentDeck = [];
        updateDisplay();
        saveState();
        return;
      }

      // Play sound
      playCardFlipSound();

      // Track deck change for visual indicator
      pendingDeckChange = -1;

      // Update display to show indicator while stamp is visible
      updateDisplay();

      // Show "Card Removed" stamp for 2 seconds (so user can read it)
      removedStamp.classList.add('visible');

      setTimeout(() => {
        removedStamp.classList.remove('visible');

        // Remove card from deck
        currentDeck.splice(currentIndex, 1);
        if (currentIndex >= currentDeck.length) {
          currentIndex = 0;
        }

        // Clear pending change and show next card with updated count
        pendingDeckChange = 0;

        // Show next card
        updateDisplay();
        saveState();
      }, 1500); // 1.5 seconds
    }

    // Add extra copies of current card (Confused)
    function addConfusedCards() {
      if (currentDeck.length === 0) return;

      // Play 2 sounds
      playCardFlipSound();
      setTimeout(() => playCardFlipSound(), 200);

      // Show "Extra Practice" stamp for 1 second
      addedStamp.classList.add('visible');

      setTimeout(() => {
        addedStamp.classList.remove('visible');

        // Add 2 copies to random positions in deck
        const card = { ...currentDeck[currentIndex] };

        for (let n = 0; n < 2; n++) {
          const randomPos = Math.floor(Math.random() * (currentDeck.length + 1));
          currentDeck.splice(randomPos, 0, { ...card, id: `${card.id}-copy-${Date.now()}-${n}` });

          // Adjust current index if we inserted before it
          if (randomPos <= currentIndex) {
            currentIndex++;
          }
        }

        // Move to next card and update display
        currentIndex = (currentIndex + 1) % currentDeck.length;
        updateDisplay();
        saveState();
      }, 1500); // 1.5 seconds
    }

    // Reset deck to original shuffled state (fresh start in current mode)
    function resetDeck() {
      if (originalDeck.length === 0) return;
      playButtonClickSound();

      // Completely reset as if we just started this pack in this mode
      currentDeck = shuffleArray([...originalDeck]);
      currentIndex = 0;

      // Reset typing state for typing modes
      if (currentMode === 'listening' || currentMode === 'writing') {
        initializeTypingDisplay();
      }

      // Reset flip state
      if (isFlipped) {
        flashcard.classList.remove('flipped');
        isFlipped = false;
      }

      // Reset deck change indicator
      pendingDeckChange = 0;

      updateDisplay();

      // Auto-pronounce in listening mode
      if (currentMode === 'listening' && currentDeck.length > 0) {
        setTimeout(() => speakSpanish(), 300);
      }

      saveState();
    }

    // Speak the Spanish word
    function speakSpanish() {
      if (currentDeck.length === 0) return;
      
      const utterance = new SpeechSynthesisUtterance(currentDeck[currentIndex].spanish);
      utterance.lang = 'es-ES';
      utterance.rate = currentSpeed;
      if (currentVoice) {
        utterance.voice = currentVoice;
      }
      speechSynthesis.cancel(); // Stop any current speech
      speechSynthesis.speak(utterance);
    }

    // Set speech speed
    function setSpeed(speed, btn) {
      currentSpeed = speed;
      speedBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      saveState();
    }

    // Levenshtein distance for string similarity
    function levenshteinDistance(str1, str2) {
      const m = str1.length;
      const n = str2.length;
      const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;

      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          if (str1[i - 1] === str2[j - 1]) {
            dp[i][j] = dp[i - 1][j - 1];
          } else {
            dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
          }
        }
      }
      return dp[m][n];
    }

    // Calculate similarity percentage
    function calculateSimilarity(expected, heard) {
      const exp = expected.toLowerCase().trim();
      const hrd = heard.toLowerCase().trim();
      
      if (exp === hrd) return 100;
      if (hrd.length === 0) return 0;
      
      const distance = levenshteinDistance(exp, hrd);
      const maxLen = Math.max(exp.length, hrd.length);
      const similarity = Math.max(0, ((maxLen - distance) / maxLen) * 100);
      
      return Math.round(similarity);
    }

    // Get feedback message based on score
    function getFeedbackMessage(score) {
      if (score >= 90) return "Â¡Excelente! Perfect!";
      if (score >= 75) return "Â¡Muy bien! Great job!";
      if (score >= 50) return "Â¡Bien! Keep practicing!";
      if (score >= 25) return "Getting there...";
      return "Try again!";
    }

    // Get score class for coloring
    function getScoreClass(score) {
      if (score >= 90) return "excellent";
      if (score >= 75) return "good";
      if (score >= 50) return "okay";
      return "poor";
    }

    // Show pronunciation feedback
    function showFeedback(score, heard, isFront = true) {
      const feedback = isFront ? feedbackFront : feedbackBack;
      const scoreEl = isFront ? scoreFront : scoreBack;
      const messageEl = isFront ? messageFront : messageBack;
      const heardEl = isFront ? heardFront : heardBack;

      scoreEl.textContent = `${score}%`;
      scoreEl.className = `feedback-score ${getScoreClass(score)}`;
      messageEl.textContent = getFeedbackMessage(score);
      heardEl.textContent = `Heard: "${heard}"`;

      feedback.classList.add('visible');

      // Speaking mode: Add penalty cards if wrong (score < 70%)
      if (currentMode === 'speaking' && score < 70) {
        addDuplicateCards(2); // Add 2 penalty cards for wrong pronunciation
      }
    }

    // Hide feedback
    function hideFeedback() {
      feedbackFront.classList.remove('visible');
      feedbackBack.classList.remove('visible');
    }

    // Start listening for pronunciation
    function startListening(isFront = true) {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser. Try Chrome or Edge.');
        return;
      }
      
      if (currentDeck.length === 0) return;
      if (isListening) return;
      
      isListening = true;
      const micBtn = isFront ? micBtnFront : micBtnBack;
      micBtn.classList.add('listening');
      
      recognition.onresult = (event) => {
        const results = event.results[0];
        let bestMatch = results[0].transcript;
        let bestScore = 0;
        
        const expected = currentDeck[currentIndex].spanish;
        
        // Check all alternatives for best match
        for (let i = 0; i < results.length; i++) {
          const transcript = results[i].transcript;
          const score = calculateSimilarity(expected, transcript);
          if (score > bestScore) {
            bestScore = score;
            bestMatch = transcript;
          }
        }
        
        showFeedback(bestScore, bestMatch, isFront);
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        micBtn.classList.remove('listening');
        
        if (event.error === 'no-speech') {
          showFeedback(0, '(no speech detected)', isFront);
        } else if (event.error === 'not-allowed') {
          alert('Microphone access denied. Please allow microphone access to use this feature.');
        }
      };
      
      recognition.onend = () => {
        isListening = false;
        micBtnFront.classList.remove('listening');
        micBtnBack.classList.remove('listening');
      };
      
      recognition.start();
    }

    // Check if setup is valid and enable start button
    function checkSetupValid() {
      const hasWordpack = wordpackSelect.value !== '';
      const hasLanguage = languageSelect.value !== '';
      startBtn.disabled = !(hasWordpack && hasLanguage);
    }

    // Update wordpack title display
    function updateWordpackTitle() {
      if (currentWordpackKey && wordpacks[currentWordpackKey]) {
        const pack = wordpacks[currentWordpackKey];
        wordpackTitle.textContent = `Lesson ${pack.meta.wordpack}. ${pack.meta.english}`;
      } else {
        wordpackTitle.textContent = '';
      }
    }

    // Start the game
    function startGame() {
      nativeLanguage = languageSelect.value;
      currentWordpackKey = wordpackSelect.value;

      // Update back label based on language
      updateBackLabel();

      // Update wordpack title
      updateWordpackTitle();

      // Exit starting card state if we're on it
      isOnStartingCard = false;

      // Initialize deck and hide setup
      initializeDeck(wordpackSelect.value);
      setupOverlay.classList.add('hidden');
      flashcard.classList.remove('setup-flipped');
      flashcard.classList.add('game-started');
      document.body.classList.add('game-started');
      gameStarted = true;
      saveState();
    }

    // Setup card flip handlers
    // Setup voice change handler
    setupVoice.addEventListener('change', () => {
      const newVoiceURI = setupVoice.value;
      currentVoice = spanishVoices.find(v => v.voiceURI === newVoiceURI) || null;
      // Play sample if game has started
      if (gameStarted && currentDeck.length > 0) {
        speakSpanish();
      }
      saveState();
    });

    // Setup speed button handlers
    setupSpeedBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        playButtonClickSound();
        const speed = parseFloat(btn.dataset.speed);
        currentSpeed = speed;
        setupSpeedBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // Play sample at new speed if game has started
        if (gameStarted && currentDeck.length > 0) {
          speakSpanish();
        }
        saveState();
      });
    });

    // Event Listeners for setup (no sounds on dropdowns)
    wordpackSelect.addEventListener('change', checkSetupValid);
    languageSelect.addEventListener('change', checkSetupValid);
    startBtn.addEventListener('click', () => {
      playButtonClickSound();
      startGame();
    });

    // Event Listeners

    prevBtn.addEventListener('click', goToPrevious);
    nextBtn.addEventListener('click', goToNext);
    gotItBtn.addEventListener('click', () => {
      playButtonClickSound();
      removeCurrentCard();
    });
    confusedBtnLeft.addEventListener('click', () => {
      playButtonClickSound();
      addConfusedCards();
    });
    confusedBtnRight.addEventListener('click', () => {
      playButtonClickSound();
      addConfusedCards();
    });
    resetBtn.addEventListener('click', resetDeck);

    // Pronounce button
    pronounceBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      playButtonClickSound();
      speakSpanish();
    });

    // Peek button (hold to flip, release to unflip)
    peekBtnFront.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      e.preventDefault();
      flipCard();
    });
    peekBtnFront.addEventListener('mouseup', (e) => {
      e.stopPropagation();
      e.preventDefault();
      unflipCard();
    });
    peekBtnFront.addEventListener('mouseleave', (e) => {
      // If user moves mouse off button while holding, unflip
      unflipCard();
    });
    // Touch support for mobile
    peekBtnFront.addEventListener('touchstart', (e) => {
      e.stopPropagation();
      e.preventDefault();
      flipCard();
    });
    peekBtnFront.addEventListener('touchend', (e) => {
      e.stopPropagation();
      e.preventDefault();
      unflipCard();
    });
    peekBtnFront.addEventListener('touchcancel', (e) => {
      e.stopPropagation();
      e.preventDefault();
      unflipCard();
    });

    // Speed buttons
    speedBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        playButtonClickSound();
        const speed = parseFloat(btn.dataset.speed);
        setSpeed(speed, btn);
        // Play sample at new speed if game has started
        if (gameStarted && currentDeck.length > 0) {
          speakSpanish();
        }
      });
    });

    // Mic buttons
    micBtnFront.addEventListener('click', (e) => {
      e.stopPropagation();
      playButtonClickSound();
      startListening(true);
    });
    micBtnBack.addEventListener('click', (e) => {
      e.stopPropagation();
      playButtonClickSound();
      startListening(false);
    });

    // Close feedback buttons
    closeFront.addEventListener('click', (e) => {
      e.stopPropagation();
      playButtonClickSound();
      hideFeedback();
    });
    closeBack.addEventListener('click', (e) => {
      e.stopPropagation();
      playButtonClickSound();
      hideFeedback();
    });

    // Menu Modal
    menuBtn.addEventListener('click', () => {
      playButtonClickSound();
      showStartingCard(false); // false = show front (menu)
    });
    
    menuClose.addEventListener('click', () => {
      playButtonClickSound();
      
      // Apply changes from menu
      const newWordpack = menuWordpack.value;
      const newLanguage = menuLanguage.value;
      const newVoiceURI = menuVoice.value;
      
      // Update voice
      currentVoice = spanishVoices.find(v => v.voiceURI === newVoiceURI) || null;
      
      // Check if wordpack or language changed
      const wordpackChanged = newWordpack !== currentWordpackKey;
      const languageChanged = newLanguage !== nativeLanguage;
      
      if (wordpackChanged || languageChanged) {
        currentWordpackKey = newWordpack;
        nativeLanguage = newLanguage;
        wordpackSelect.value = newWordpack;
        languageSelect.value = newLanguage;
        updateBackLabel();
        updateWordpackTitle();

        // Re-initialize deck if game has started
        if (gameStarted) {
          initializeDeck(currentWordpackKey);
        }
      }
      
      saveState();
      menuModal.classList.remove('visible');
    });
    
    menuModal.addEventListener('click', (e) => {
      if (e.target === menuModal) {
        menuModal.classList.remove('visible');
      }
    });

    // Voice change - play sample pronunciation
    menuVoice.addEventListener('change', () => {
      const newVoiceURI = menuVoice.value;
      currentVoice = spanishVoices.find(v => v.voiceURI === newVoiceURI) || null;
      // Play sample if game has started and there's a current card
      if (gameStarted && currentDeck.length > 0) {
        speakSpanish();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Close modals with Escape
      if (e.key === 'Escape') {
        menuModal.classList.remove('visible');
        return;
      }

      // Don't handle navigation if modal is open
      if (menuModal.classList.contains('visible')) {
        return;
      }

      // Handle typing in listening and writing modes (accept letters, numbers, symbols - not space)
      if ((currentMode === 'listening' || currentMode === 'writing') && e.key.length === 1 && e.key !== ' ') {
        e.preventDefault();
        handleTypingInput(e.key);
        return;
      }

      // Enter in typing modes (listening/writing)
      if ((currentMode === 'listening' || currentMode === 'writing') && e.key === 'Enter') {
        e.preventDefault();
        if (isWritingComplete()) {
          moveToNextCard();
        }
        return;
      }

      // Prevent repeated actions when holding key down
      if (keysPressed[e.key]) {
        e.preventDefault();
        return;
      }
      keysPressed[e.key] = true;

      if (e.key === 'ArrowLeft') {
        // Only allow left arrow in reading mode
        if (currentMode === 'reading') {
          goToPrevious();
        }
      } else if (e.key === 'ArrowRight') {
        // Only allow right arrow in reading mode
        if (currentMode === 'reading') {
          goToNext();
        }
      } else if (e.key === 'ArrowUp') {
        // Up arrow: ALWAYS pronounce
        e.preventDefault();
        speakSpanish();
      } else if (e.key === 'ArrowDown') {
        // Down arrow: ALWAYS flip
        e.preventDefault();
        flipCard();
      } else if (e.key === '1') {
        // Key 1: Remove card (Got it!) - only in reading mode
        if (currentMode === 'reading') {
          e.preventDefault();
          removeCurrentCard();
        }
      } else if (e.key === '2') {
        // Key 2: Add practice cards (Confused) - only in reading mode
        if (currentMode === 'reading') {
          e.preventDefault();
          addConfusedCards();
        }
      } else if (e.key === ' ') {
        // Space: pronounce in reading mode, record in speaking mode, play sound in writing mode, ignore in listening
        if (currentMode === 'reading') {
          e.preventDefault();
          speakSpanish();
        } else if (currentMode === 'speaking') {
          e.preventDefault();
          // Trigger mic button based on which side of card is showing
          const isFront = !isFlipped;
          startListening(isFront);
        } else if (currentMode === 'writing') {
          e.preventDefault();
          playScribbleSound(); // Play scribble sound but don't register input
        } else if (currentMode === 'listening') {
          e.preventDefault(); // Ignore space in listening mode
        }
      }
    });

    document.addEventListener('keyup', (e) => {
      // Clear key state
      keysPressed[e.key] = false;

      if (e.key === 'ArrowDown') {
        unflipCard();
      }
    });

    // Mode selector event listeners - DISABLED (locked to reading mode)
    // modeBtns.forEach(btn => {
    //   btn.addEventListener('click', () => {
    //     playButtonClickSound();
    //     const mode = btn.dataset.mode;
    //     switchMode(mode);
    //   });
    // });

    // Initialize
    loadWordpacks();
  </script>
</body>
</html>
