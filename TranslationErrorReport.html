<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Error Report - Stage 3A/3B Audit</title>

    <!-- ============================================================
         PROGRAM: Translation Error Report Viewer
         Core Purpose: Visual audit tool for translation data quality before AI fixes
         ============================================================

         WHAT THIS PROGRAM DOES:
         -----------------------
         - Loads and displays CSV error summary files for Chinese, Spanish, and English wordpacks
         - Shows which wordpacks have pinyin errors, bracket errors, and empty cells
         - Provides summary statistics (total packs, clean packs, packs with errors, total issues)
         - Allows exporting filtered reports to CSV for further analysis
         - Auto-loads Chinese Stage 3A report on page load for quick access

         HOW IT WORKS:
         -------------
         - User selects language (Chinese/Spanish/English) and stage (3A/3B) from dropdowns
         - Fetches corresponding CSV error summary file generated by Python scripts:
           * ChineseErrorsSummary3A.csv (includes Reason column)
           * ChineseErrorsSummary3B.csv (minimal, no Reason)
           * SpanishErrorsSummary3A.csv
           * etc.
         - Parses CSV data and displays in sortable HTML table
         - Highlights error cells in red, clean cells in green
         - Calculates and displays aggregate statistics at the top
         - Export button generates downloadable CSV from displayed data

         KEY FEATURES:
         -------------
         1. Multi-language Support: Works with all three language datasets (Chinese, Spanish, English)
         2. Stage Toggle: Switch between detailed 3A reports (with Reason) and minimal 3B reports
         3. Visual Error Highlighting: Red cells immediately show problem areas, green shows clean data
         4. Summary Statistics: At-a-glance view of data quality (how many packs need fixing)
         5. CSV Export: Download current view for offline analysis or sharing
         6. Auto-load Default: Opens Chinese 3A by default for fastest workflow

         USAGE:
         ------
         1. Select language from dropdown (Chinese, Spanish, or English)
         2. Select stage (3A for detailed with Reason, 3B for minimal)
         3. Click "Load Report" to fetch and display the CSV error summary
         4. Review the table to see which packs have errors
         5. Use "Export to CSV" to download the current report
         6. Use this report to identify which packs need fixing before running Stage 3A/3B prompts

         WORKFLOW INTEGRATION:
         ---------------------
         This tool fits into the translation QA pipeline:
         1. Run: python PythonHelpers/generate_error_summary.py chinese 3a
         2. Open this HTML to review errors visually
         3. Identify problem packs
         4. Run Stage 3A/3B prompts to generate fixes
         5. Apply fixes and regenerate modules

         ============================================================ -->
    <style>
        /* ============================================================
           DESIGN SYSTEM
           ============================================================
           Clean, professional table-based UI for data auditing.
           Uses green/red color coding for instant error identification.
           Design priorities:
           - Readability: Large fonts, ample spacing, clear hierarchy
           - Scannability: Striped rows, sticky headers, hover effects
           - Visual feedback: Error cells highlighted in red, clean cells in green
           ============================================================ */

        /* ============================================================
           SECTION: Base Layout
           ============================================================
           Light gray background with white content cards for clarity.
           Modern sans-serif font for professional appearance.
           ============================================================ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5; /* Subtle gray to make white cards pop */
        }

        /* ============================================================
           SECTION: Headers
           ============================================================
           Green accent color (#4CAF50) signals "data quality" theme.
           H1 has thick bottom border for strong visual anchor.
           H2 uses subtle gray background for section separation.
           ============================================================ */
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50; /* Green = quality/validation theme */
            padding-bottom: 10px;
        }

        h2 {
            color: #666;
            margin-top: 30px;
            background: #e0e0e0; /* Light gray background for section headers */
            padding: 10px;
            border-radius: 5px;
        }

        /* ============================================================
           SECTION: Control Panel
           ============================================================
           White card with shadow contains language/stage dropdowns.
           Provides clear separation from report content below.
           ============================================================ */
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle depth */
        }

        /* ============================================================
           SECTION: Form Controls (Dropdowns and Buttons)
           ============================================================
           Standard input styling with green accent for buttons.
           Hover effect on buttons provides visual feedback.
           ============================================================ */
        select, button {
            padding: 8px 15px;
            margin-right: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        button {
            background: #4CAF50; /* Green matches data quality theme */
            color: white;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background: #45a049; /* Slightly darker green on hover */
        }

        /* ============================================================
           SECTION: Data Table
           ============================================================
           Core of the UI - displays error report in tabular format.
           Sticky header stays visible during scroll for column reference.
           Striped rows and hover effect improve scannability.
           ============================================================ */
        table {
            width: 100%;
            border-collapse: collapse; /* Clean borders without gaps */
            background: white;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px; /* Generous padding for readability */
            text-align: left;
        }

        th {
            background: #4CAF50; /* Green header matches theme */
            color: white;
            font-weight: bold;
            position: sticky; /* Header stays visible during scroll */
            top: 0;
            z-index: 10; /* Above table body */
        }

        tr:nth-child(even) {
            background: #f9f9f9; /* Zebra striping for row tracking */
        }

        tr:hover {
            background: #f0f0f0; /* Highlight on hover for focus */
        }

        /* ============================================================
           SECTION: Error Highlighting (Critical Feature)
           ============================================================
           Red cells = errors that need fixing (pinyin, brackets, empty cells)
           Green text = clean packs with zero issues
           This visual coding allows instant error identification.
           ============================================================ */
        .error-cell {
            background: #ffebee !important; /* Light red background */
            color: #c62828; /* Dark red text */
            font-weight: bold; /* Errors stand out */
        }

        .no-errors {
            color: #2e7d32; /* Green text for clean data */
        }

        /* ============================================================
           SECTION: Summary Statistics Panel
           ============================================================
           Blue-themed cards display aggregate stats at a glance.
           Shows: Total packs, clean packs, packs with errors, total issues.
           Large numbers draw attention to key metrics.
           ============================================================ */
        .summary {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-stat {
            display: inline-block; /* Horizontal layout */
            margin-right: 30px;
            padding: 10px 20px;
            background: #e3f2fd; /* Light blue for stats */
            border-radius: 5px;
            border-left: 4px solid #2196F3; /* Blue accent bar */
        }

        .summary-stat strong {
            font-size: 24px; /* Large numbers for quick scanning */
            color: #1976D2; /* Darker blue for contrast */
        }

        /* ============================================================
           SECTION: UI States (Loading and Error Messages)
           ============================================================
           Loading state shows while fetching CSV data.
           Error message appears if CSV file not found (prompts user to generate it).
           ============================================================ */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666; /* Subtle gray for loading text */
        }

        .error-message {
            background: #ffebee; /* Light red background */
            color: #c62828; /* Dark red text */
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üìä Translation Error Report - Stage 3A/3B Audit</h1>

    <p><strong>Purpose:</strong> This report shows you exactly what the AI sees before it starts fixing translations.</p>
    <p><strong>Usage:</strong> Review errors, then run Stage 3A or 3B prompts to fix them.</p>

    <div class="controls">
        <label for="language">Language:</label>
        <select id="language">
            <option value="chinese">Chinese (107 packs)</option>
            <option value="spanish">Spanish (250 packs)</option>
            <option value="english">English (160 packs)</option>
        </select>

        <label for="stage">Stage:</label>
        <select id="stage">
            <option value="3a">3A (with Reason)</option>
            <option value="3b">3B (minimal)</option>
        </select>

        <button onclick="loadReport()">Load Report</button>
        <button onclick="exportToCSV()">Export to CSV</button>
    </div>

    <div id="summary" class="summary" style="display:none;"></div>
    <div id="report"></div>

    <script>
        // ============================================================
        // JAVASCRIPT OVERVIEW
        // ============================================================
        // Handles CSV loading, parsing, display, and export functionality.
        // Main workflow:
        //   1. User selects language/stage ‚Üí loadReport()
        //   2. Fetch CSV file from server
        //   3. Parse CSV into JavaScript objects
        //   4. Display table with error highlighting
        //   5. Calculate and display summary statistics
        //   6. Allow CSV export of displayed data
        // ============================================================

        // Global variable to store currently loaded data for export functionality
        let currentData = [];

        // ============================================================
        // KEY FEATURE: Load and Display Error Report
        // Core Objective: Fetch CSV error summary and display it visually
        // Key Behaviors:
        //   - Constructs filename based on selected language and stage
        //   - Fetches CSV from server (generated by Python script)
        //   - Parses CSV into objects with proper field mapping
        //   - Displays data in HTML table with error highlighting
        //   - Shows helpful error message if file not found
        // ============================================================
        async function loadReport() {
            const language = document.getElementById('language').value;
            const stage = document.getElementById('stage').value;

            const reportDiv = document.getElementById('report');
            const summaryDiv = document.getElementById('summary');

            // Show loading state while fetching data
            reportDiv.innerHTML = '<div class="loading">Loading...</div>';
            summaryDiv.style.display = 'none';

            // Construct filename: ChineseWords/ChineseErrorsSummary3A.csv, etc.
            const filename = `${language.charAt(0).toUpperCase() + language.slice(1)}Words/${language.charAt(0).toUpperCase() + language.slice(1)}ErrorsSummary${stage.toUpperCase()}.csv`;

            try {
                // Fetch CSV file from server
                const response = await fetch(filename);

                if (!response.ok) {
                    // File not found - show helpful error with command to generate it
                    throw new Error(`File not found: ${filename}. Run: python PythonHelpers/generate_error_summary.py ${language} ${stage}`);
                }

                // Parse CSV text into JavaScript objects
                const csvText = await response.text();
                const rows = parseCSV(csvText);

                // Store for export functionality
                currentData = rows;

                // Display table and summary statistics
                displayReport(rows, language, stage);
                displaySummary(rows);

            } catch (error) {
                // Show error message to user with instructions
                reportDiv.innerHTML = `<div class="error-message">‚ùå ${error.message}</div>`;
            }
        }

        // ============================================================
        // KEY FEATURE: CSV Parser
        // Core Objective: Convert CSV text into JavaScript objects
        // Key Behaviors:
        //   - Splits CSV into lines
        //   - Parses header row for field names
        //   - Parses each data row into object with field mapping
        //   - Handles quoted values and commas within fields
        // ============================================================
        function parseCSV(text) {
            // Split CSV into lines
            const lines = text.trim().split('\n');
            // First line = headers (Pack_Number, Pack_Title, etc.)
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];

            // Parse each data line into an object
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};

                // Map values to header names
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });

                rows.push(row);
            }

            return rows; // Array of objects with header-keyed fields
        }

        // ============================================================
        // KEY FEATURE: CSV Line Parser (Handles Quoted Fields)
        // Core Objective: Parse single CSV line respecting quotes
        // Key Behaviors:
        //   - Tracks quote state to handle commas inside quoted fields
        //   - Returns array of field values
        //   - Handles edge cases like quotes within quotes
        // ============================================================
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false; // Track whether we're inside quotes

            // Scan each character
            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    // Toggle quote state
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    // Comma outside quotes = field separator
                    result.push(current.trim());
                    current = '';
                } else {
                    // Regular character - add to current field
                    current += char;
                }
            }

            // Push final field
            result.push(current.trim());
            return result; // Array of field values
        }

        // ============================================================
        // KEY FEATURE: Display Report Table
        // Core Objective: Render error data as HTML table with highlighting
        // Key Behaviors:
        //   - Builds HTML table with headers and rows
        //   - Applies .error-cell class to cells with errors (red background)
        //   - Applies .no-errors class to Total_Issues = 0 (green text)
        //   - Shows Pack #, Pack Title, Difficulty, error counts
        // ============================================================
        function displayReport(rows, language, stage) {
            const reportDiv = document.getElementById('report');

            // Build table HTML
            let html = `<h2>${language.toUpperCase()} - Stage ${stage.toUpperCase()} Error Summary</h2>`;
            html += '<table>';
            html += '<thead><tr>';
            html += '<th>Pack #</th>';
            html += '<th>Pack Title</th>';
            html += '<th>Difficulty/Act</th>';
            html += '<th>Total Issues</th>';
            html += '<th>Pinyin Errors</th>';
            html += '<th>Bracket Errors</th>';
            html += '<th>Empty Cells</th>';
            html += '</tr></thead><tbody>';

            // Add row for each pack
            rows.forEach(row => {
                const hasErrors = parseInt(row.Total_Issues || 0) > 0;

                html += '<tr>';
                html += `<td>${row.Pack_Number}</td>`;
                html += `<td>${row.Pack_Title}</td>`;
                html += `<td>${row.Difficulty_Act}</td>`;
                // Highlight Total_Issues cell: red if errors, green if clean
                html += `<td class="${hasErrors ? 'error-cell' : 'no-errors'}">${row.Total_Issues || '0'}</td>`;
                // Highlight individual error type cells if they have errors
                html += `<td class="${row.Pinyin_Errors ? 'error-cell' : ''}">${row.Pinyin_Errors || '-'}</td>`;
                html += `<td class="${row.Bracket_Errors ? 'error-cell' : ''}">${row.Bracket_Errors || '-'}</td>`;
                html += `<td class="${row.Empty_Cells ? 'error-cell' : ''}">${row.Empty_Cells || '-'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            reportDiv.innerHTML = html;
        }

        // ============================================================
        // KEY FEATURE: Summary Statistics Calculator
        // Core Objective: Display aggregate data quality metrics
        // Key Behaviors:
        //   - Counts total packs, packs with errors, clean packs
        //   - Sums total issues across all packs
        //   - Displays in blue stat cards above the table
        //   - Provides at-a-glance view of data quality
        // ============================================================
        function displaySummary(rows) {
            const summaryDiv = document.getElementById('summary');

            // Calculate aggregate statistics
            const totalPacks = rows.length;
            const packsWithErrors = rows.filter(r => parseInt(r.Total_Issues || 0) > 0).length;
            const totalIssues = rows.reduce((sum, r) => sum + parseInt(r.Total_Issues || 0), 0);
            const cleanPacks = totalPacks - packsWithErrors;

            // Build summary HTML with blue stat cards
            let html = '<h3>Summary Statistics</h3>';
            html += `<div class="summary-stat">Total Packs: <strong>${totalPacks}</strong></div>`;
            html += `<div class="summary-stat">Clean Packs: <strong>${cleanPacks}</strong></div>`;
            html += `<div class="summary-stat">Packs with Errors: <strong>${packsWithErrors}</strong></div>`;
            html += `<div class="summary-stat">Total Issues: <strong>${totalIssues}</strong></div>`;

            summaryDiv.innerHTML = html;
            summaryDiv.style.display = 'block'; // Make summary visible
        }

        // ============================================================
        // KEY FEATURE: CSV Export
        // Core Objective: Download currently displayed data as CSV file
        // Key Behaviors:
        //   - Converts currentData back to CSV format
        //   - Handles escaping of commas and quotes
        //   - Triggers browser download with appropriate filename
        //   - Allows offline analysis or sharing of filtered data
        // ============================================================
        function exportToCSV() {
            // Validate data is loaded
            if (currentData.length === 0) {
                alert('No data loaded. Please load a report first.');
                return;
            }

            // Build CSV from currentData
            const headers = Object.keys(currentData[0]);
            let csv = headers.join(',') + '\n'; // Header row

            currentData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // Escape commas and quotes (CSV standard)
                    return value.includes(',') || value.includes('"') ? `"${value.replace(/"/g, '""')}"` : value;
                });
                csv += values.join(',') + '\n';
            });

            // Create download blob and trigger download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Filename includes language and stage for easy identification
            a.download = `error_report_${document.getElementById('language').value}_${document.getElementById('stage').value}.csv`;
            a.click();
            window.URL.revokeObjectURL(url); // Clean up
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        // Auto-load Chinese 3A report on page load for fastest workflow.
        // Chinese is default because it's the most commonly audited dataset.
        // ============================================================
        window.addEventListener('DOMContentLoaded', () => {
            loadReport(); // Loads Chinese 3A by default
        });
    </script>
</body>
</html>
